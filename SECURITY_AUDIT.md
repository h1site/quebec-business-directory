# Audit de S√©curit√© Supabase - Registre du Qu√©bec

Date de l'audit: 2025-10-26

## ‚úÖ Checklist de S√©curit√©

### üîê Auth & Cl√©s

- [x] **RLS activ√© partout** - V√©rifi√© sur user_profiles, business_reviews, businesses
- [x] **Politiques par d√©faut = deny** - RLS configur√© avec politiques explicites
- [x] **Cl√© service_role jamais c√¥t√© client** - ‚úÖ CONFORME
  - Aucune utilisation de service_role dans `src/`
  - Scripts backend utilisent `SUPABASE_SERVICE_KEY` depuis `.env` (jamais commit√©)
- [x] **Rotation p√©riodique des cl√©s** - ‚ö†Ô∏è √Ä planifier (recommandation: tous les 6 mois)
- [ ] **Domaines de redirection (Auth)** - ‚ö†Ô∏è √Ä v√©rifier dans console Supabase
- [x] **Inscription: email confirmation** - √Ä v√©rifier dans Supabase Auth settings
- [ ] **Providers OAuth: secrets c√¥t√© serveur** - N/A (pas encore impl√©ment√©)
- [x] **CORS: origines explicites** - G√©r√© par Supabase, √† v√©rifier dans console

### üóÑÔ∏è Base de donn√©es & RLS

#### Tables avec RLS activ√©:
- [x] **user_profiles**
  - ‚úÖ SELECT: Public (tous peuvent voir)
  - ‚úÖ INSERT: Auth uniquement (auth.uid() = user_id)
  - ‚úÖ UPDATE: Propri√©taire uniquement (auth.uid() = user_id)
  - ‚ùå DELETE: Pas de politique (√† ajouter si n√©cessaire)

- [x] **business_reviews**
  - ‚úÖ SELECT: Public (tous peuvent voir)
  - ‚úÖ INSERT: Auth uniquement (auth.uid() = user_id)
  - ‚úÖ UPDATE: Propri√©taire uniquement (auth.uid() = user_id)
  - ‚úÖ DELETE: Propri√©taire uniquement (auth.uid() = user_id)

- [x] **businesses** - ‚ö†Ô∏è RLS √† v√©rifier dans SCRIPT_SUPABASE.sql

- [x] **business_claims** - √Ä v√©rifier

- [x] **admins** - RLS critique √† v√©rifier

#### Fonctions SQL
- [x] **calculate_business_average_rating** - ‚úÖ Pas de SECURITY DEFINER, lecture seule
- [x] **count_business_reviews** - ‚úÖ Pas de SECURITY DEFINER, lecture seule
- [x] **update_updated_at_column** - ‚úÖ TRIGGER s√©curis√©

#### Recommandations:
- [ ] Cr√©er des vues pour colonnes sensibles (emails, donn√©es priv√©es)
- [ ] Ajouter pagination stricte sur endpoints publics
- [ ] Index sur created_at pour √©viter l'√©num√©ration

### üì¶ Stockage (Buckets)

#### Bucket: `avatars`
- [x] **Type: Public** - ‚úÖ Justifi√© (avatars publics)
- [x] **SELECT Policy** - ‚úÖ Public accessible
- [x] **INSERT Policy** - ‚úÖ Utilisateur peut uploader seulement dans son dossier (auth.uid())
- [x] **UPDATE Policy** - ‚úÖ Utilisateur peut modifier seulement son avatar
- [x] **DELETE Policy** - ‚úÖ Utilisateur peut supprimer seulement son avatar

#### Bucket: `review-photos`
- [x] **Type: Public** - ‚úÖ Justifi√© (photos de critiques publiques)
- [x] **SELECT Policy** - ‚úÖ Public accessible
- [x] **INSERT Policy** - ‚ö†Ô∏è **PROBL√àME D√âTECT√â**
  - Politique actuelle: Tout utilisateur authentifi√© peut uploader n'importe o√π
  - **Recommandation**: Ajouter validation du propri√©taire
- [x] **DELETE Policy** - ‚ö†Ô∏è **PROBL√àME D√âTECT√â**
  - Politique actuelle: N'importe quel utilisateur auth peut supprimer n'importe quelle photo
  - **Recommandation**: Restreindre au propri√©taire de la critique

#### Validations n√©cessaires:
- [ ] Validation MIME/extension c√¥t√© client ET serveur
- [ ] Validation taille (max 2MB pour avatars mentionn√© dans UI)
- [x] Signed URLs avec TTL - N/A (buckets publics)

### üîß Edge Functions / Middleware

- [ ] N/A - Pas encore impl√©ment√©

### üåê API publique (PostgREST / Realtime)

- [x] **Filtres stricts sur endpoints** - RLS en place
- [x] **Row filters dans policies** - ‚úÖ user_id = auth.uid() utilis√©
- [ ] **Realtime: canaux limit√©s** - √Ä v√©rifier si utilis√©

### üíª Frontend

- [x] **Jamais de secret c√¥t√© client** - ‚úÖ CONFORME
  - Seulement `VITE_SUPABASE_ANON_KEY` utilis√© (safe)
  - `VITE_SUPABASE_URL` public (safe)
- [x] **T√©l√©versement s√©curis√©** - Contr√¥les c√¥t√© client pr√©sents (taille, MIME)
- [x] **Nettoyage des tokens** - √Ä v√©rifier dans logout flow
- [x] **Storage s√©curis√©** - Supabase Auth g√®re les tokens

### üîÑ CI/CD & D√©p√¥ts

- [x] **.env.example sans secrets** - ‚úÖ CONFORME
  - Contient seulement les placeholders
- [ ] **Scans de secrets activ√©s** - ‚ö†Ô∏è √Ä configurer (GitHub secret scanning)
- [ ] **Migrations revues** - ‚ö†Ô∏è √Ä v√©rifier (pas de ALTER TABLE DISABLE RLS trouv√©)
- [ ] **.gitignore** - ‚úÖ .env pr√©sent dans .gitignore

### üë• Organisation & Acc√®s

- [ ] **2FA activ√©** - ‚ö†Ô∏è √Ä v√©rifier pour compte Supabase et GitHub
- [ ] **R√¥les minimaux** - √Ä v√©rifier dans org Supabase
- [ ] **Comptes techniques s√©par√©s** - √Ä √©valuer selon besoin

### üìä Observabilit√© & Incidents

- [ ] **Logs Auth/SQL/Functions** - √Ä activer dans Supabase
- [ ] **Rate limiting** - ‚ö†Ô∏è √Ä configurer (protection contre abus)
- [ ] **Backups & PITR test√©s** - ‚ö†Ô∏è Critique - √† tester
- [ ] **Plan d'incident document√©** - √Ä cr√©er

---

## üö® Probl√®mes Critiques D√©tect√©s

### 1. **CRITIQUE: review-photos bucket trop permissif**

**Probl√®me**: N'importe quel utilisateur authentifi√© peut:
- Uploader des photos n'importe o√π dans le bucket
- Supprimer n'importe quelle photo (pas seulement les siennes)

**Impact**:
- Utilisateur malveillant peut supprimer toutes les photos de critiques
- Peut uploader du contenu inappropri√©

**Solution recommand√©e**:
```sql
-- Remplacer la policy DELETE actuelle
DROP POLICY "Users can delete review photos" ON storage.objects;

CREATE POLICY "Users can delete their own review photos"
  ON storage.objects FOR DELETE
  USING (
    bucket_id = 'review-photos'
    AND auth.uid() IS NOT NULL
    AND (
      -- V√©rifier que la photo appartient √† une critique de l'utilisateur
      EXISTS (
        SELECT 1 FROM business_reviews br
        WHERE br.user_id = auth.uid()
        AND name = ANY(br.photos)
      )
    )
  );

-- Am√©liorer la policy INSERT
DROP POLICY "Authenticated users can upload review photos" ON storage.objects;

CREATE POLICY "Users can upload review photos with path validation"
  ON storage.objects FOR INSERT
  WITH CHECK (
    bucket_id = 'review-photos'
    AND auth.uid() IS NOT NULL
    -- Forcer un format de path: user_id/filename
    AND (storage.foldername(name))[1] = auth.uid()::text
  );
```

### 2. **IMPORTANT: Scripts utilisent service_role inconsistant**

**Probl√®me**: Plusieurs scripts utilisent `SUPABASE_SERVICE_KEY` qui pourrait √™tre expos√©

**Scripts concern√©s**:
- `scripts/test-req-system.js`
- `scripts/hide-businesses-without-contact.js`
- `scripts/assign-default-category.js`
- Et 40+ autres scripts

**Solution**:
- ‚úÖ Ces scripts sont backend-only (pas dans src/)
- ‚ö†Ô∏è S'assurer que `.env` n'est JAMAIS commit√©
- ‚ö†Ô∏è Ajouter pre-commit hook pour scanner les secrets

### 3. **MOYEN: Validation MIME manquante c√¥t√© serveur**

**Probl√®me**: Upload d'avatars valid√© seulement c√¥t√© client

**Solution**: Ajouter validation c√¥t√© serveur via Edge Function ou RPC

---

## üìã Actions Imm√©diates Recommand√©es

### Priorit√© 1 (Critique - √† faire maintenant)
1. ‚úÖ Fixer les policies du bucket `review-photos`
2. ‚úÖ Activer GitHub secret scanning
3. ‚úÖ V√©rifier que `.env` est bien dans `.gitignore`

### Priorit√© 2 (Important - cette semaine)
4. ‚ö†Ô∏è Tester les backups Supabase (restoration test)
5. ‚ö†Ô∏è Activer 2FA sur compte Supabase
6. ‚ö†Ô∏è Configurer rate limiting sur API

### Priorit√© 3 (Maintenance - ce mois)
7. ‚ö†Ô∏è Cr√©er plan de rotation des cl√©s
8. ‚ö†Ô∏è Documenter plan d'incident
9. ‚ö†Ô∏è Ajouter validation MIME c√¥t√© serveur
10. ‚ö†Ô∏è Revoir toutes les tables pour RLS (businesses, business_claims, admins)

---

## üîç Tests de S√©curit√© √† Effectuer

### Test 1: √ânum√©ration des donn√©es
```bash
# Tester si on peut lire toutes les critiques sans limite
curl 'https://[PROJECT].supabase.co/rest/v1/business_reviews?select=*&limit=10000' \
  -H "apikey: [ANON_KEY]"
```

### Test 2: Upload non autoris√©
```bash
# Essayer d'uploader dans le dossier d'un autre utilisateur
# (devrait √™tre bloqu√©)
```

### Test 3: Suppression non autoris√©e
```bash
# Essayer de supprimer la photo d'un autre utilisateur
# (devrait √™tre bloqu√© apr√®s fix)
```

### Test 4: Acc√®s aux donn√©es admin
```bash
# Essayer de lire la table admins sans auth
# (devrait √™tre bloqu√© si RLS configur√©)
```

---

## üìù Notes

- Frontend utilise UNIQUEMENT `anon` key ‚úÖ
- Aucune cl√© secr√®te dans le code source ‚úÖ
- Scripts backend s√©par√©s du frontend ‚úÖ
- Storage policies bien configur√©s pour avatars ‚úÖ
- **review-photos n√©cessite correctifs URGENTS** ‚ö†Ô∏è

---

## üîÑ Prochaine R√©vision

- **Date pr√©vue**: 2025-11-26 (dans 1 mois)
- **Responsable**: S√©bastien Ross
- **Focus**: V√©rifier impl√©mentation des correctifs
