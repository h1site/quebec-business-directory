# Syst√®me de R√©clamation de Fiche d'Entreprise

## üìã Vue d'ensemble

Le syst√®me de r√©clamation permet aux propri√©taires d'entreprises de revendiquer et g√©rer leurs fiches dans l'annuaire. Trois m√©thodes de v√©rification sont disponibles, avec une approbation automatique pour les emails avec domaine correspondant.

## üîê M√©thodes de V√©rification

### 1. Email Domaine (Auto-approuv√© ‚úÖ)

**Comment √ßa fonctionne:**
- L'utilisateur se connecte avec un email dont le domaine correspond au site web de l'entreprise
- Le syst√®me v√©rifie automatiquement la correspondance
- Approbation instantan√©e sans intervention admin

**Exemples:**

| Email utilisateur | Site web entreprise | R√©sultat |
|-------------------|---------------------|----------|
| info@h1site.com | https://h1site.com | ‚úÖ Auto-approuv√© |
| contact@duvaltex.ca | www.duvaltex.ca | ‚úÖ Auto-approuv√© |
| jean@gmail.com | https://h1site.com | ‚ùå V√©rification manuelle requise |

**Logique technique:**
```sql
-- Fonction de v√©rification
CREATE FUNCTION check_email_domain_match(email, website) RETURNS BOOLEAN

-- Extraction du domaine email: info@h1site.com ‚Üí h1site.com
-- Extraction du domaine site: https://www.h1site.com/path ‚Üí h1site.com
-- Comparaison: h1site.com = h1site.com ‚Üí TRUE
```

**Trigger automatique:**
```sql
CREATE TRIGGER auto_approve_business_claim
  BEFORE INSERT ON business_claims
  FOR EACH ROW
  EXECUTE FUNCTION auto_approve_claim_if_domain_match();
```

### 2. Google My Business üîó

**Comment √ßa fonctionne:**
1. L'utilisateur fournit l'URL de sa fiche Google My Business
2. L'utilisateur ajoute temporairement un code de v√©rification dans la description Google
3. L'admin v√©rifie la pr√©sence du code sur la fiche Google
4. L'admin approuve ou rejette manuellement

**Code de v√©rification:**
```
CODE-VERIFICATION-[8 premiers caract√®res de l'UUID de l'entreprise]
Exemple: CODE-VERIFICATION-B726F537
```

**Instructions pour l'utilisateur:**
1. Connectez-vous √† Google My Business
2. Modifiez la description de votre fiche
3. Ajoutez le code de v√©rification fourni
4. Collez l'URL de votre fiche Google Maps
5. Soumettez la demande

**V√©rification admin:**
- Ouvrir l'URL Google fournie
- V√©rifier la pr√©sence du code dans la description
- Approuver si code pr√©sent, rejeter sinon

### 3. V√©rification Manuelle üìù

**Comment √ßa fonctionne:**
1. L'utilisateur explique pourquoi il r√©clame cette fiche
2. L'admin contacte l'utilisateur par email ou t√©l√©phone
3. L'admin demande une preuve (facture, permis, document NEQ, etc.)
4. L'admin approuve ou rejette avec notes

**Informations fournies:**
- Nom complet
- Num√©ro de t√©l√©phone
- Message expliquant le lien avec l'entreprise

**Preuves acceptables:**
- Facture r√©cente de l'entreprise
- Permis d'affaires
- Document d'incorporation (NEQ)
- Relev√© bancaire au nom de l'entreprise
- Bail commercial
- Certificat d'assurance

## üóÑÔ∏è Structure de la Base de Donn√©es

### Table `business_claims`

```sql
CREATE TABLE business_claims (
  id UUID PRIMARY KEY,
  business_id UUID REFERENCES businesses(id),
  user_id UUID REFERENCES auth.users(id),

  -- Statut
  status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected
  verification_method VARCHAR(50), -- email_domain, google_business, manual

  -- Info utilisateur
  user_email VARCHAR(255) NOT NULL,
  user_name VARCHAR(255),
  user_phone VARCHAR(50),

  -- Donn√©es de v√©rification
  verification_data JSONB, -- { googleBusinessUrl, message, etc. }
  notes TEXT, -- Notes admin (raison du refus, etc.)

  -- Timestamps
  claimed_at TIMESTAMP DEFAULT NOW(),
  verified_at TIMESTAMP,
  verified_by UUID REFERENCES auth.users(id),

  UNIQUE(business_id, user_id)
);
```

### Colonnes ajout√©es √† `businesses`

```sql
ALTER TABLE businesses ADD COLUMN:
- claimed_by UUID REFERENCES auth.users(id)
- claimed_at TIMESTAMP
- is_claimed BOOLEAN DEFAULT FALSE
```

## üé® Interface Utilisateur

### Bouton "R√©clamer votre fiche"

**Emplacement:** Page d√©tails de l'entreprise (BusinessDetails.jsx)

**Conditions d'affichage:**
- ‚úÖ Entreprise NON r√©clam√©e (`is_claimed = false`)
- ‚úÖ Utilisateur connect√© ou bouton redirige vers login

**√âtats:**
```jsx
{!business.is_claimed && user && !isOwner && (
  <button onClick={() => setShowClaimModal(true)}>
    üìã R√©clamer votre fiche
  </button>
)}

{!business.is_claimed && !user && (
  <button onClick={() => navigate('/login')}>
    üìã R√©clamer votre fiche
  </button>
)}
```

### Modal de R√©clamation (ClaimBusinessModal)

**√âtapes:**
1. **S√©lection** ‚Üí Choix de la m√©thode (Google Business ou Manuel)
2. **Formulaire** ‚Üí Remplir les informations requises
3. **R√©sultat** ‚Üí Success (auto-approuv√©) | Pending (en attente) | Error

**D√©tection auto-approbation:**
```jsx
const canAutoApprove = () => {
  const emailDomain = user.email.split('@')[1].toLowerCase();
  const websiteDomain = business.website
    .replace(/^https?:\/\//, '')
    .replace(/^www\./, '')
    .replace(/\/.*$/, '')
    .toLowerCase();
  return emailDomain === websiteDomain;
};
```

## üõ†Ô∏è Interface Admin

### Page Admin Claims (`/admin/claims`)

**Filtres:**
- Toutes
- En attente (pending)
- Approuv√©es (approved)
- Rejet√©es (rejected)

**Informations affich√©es:**
- Nom de l'entreprise et ville
- Nom et email du demandeur
- T√©l√©phone du demandeur
- M√©thode de v√©rification
- Date de la demande
- Site web de l'entreprise
- T√©l√©phone de l'entreprise
- Message ou URL Google Business
- Notes admin (si rejet√©e)

**Actions:**
- ‚úì Approuver ‚Üí Marque claimed, assigne l'utilisateur
- ‚úó Rejeter ‚Üí Demande raison, ajoute notes
- üëÅ Voir la fiche ‚Üí Ouvre la page de l'entreprise

### Dashboard Admin

**Statistique ajout√©e:**
```jsx
<Link to="/admin/claims" className="stat-card stat-card-clickable">
  <div className="stat-value">{stats.pendingClaims}</div>
  <div className="stat-label">R√©clamations en attente</div>
</Link>
```

**Style:**
- Fond jaune (alerte)
- Effet hover avec √©l√©vation
- Clickable vers /admin/claims

## üîí S√©curit√© et Permissions

### Row Level Security (RLS)

**Utilisateurs peuvent:**
- ‚úÖ Voir leurs propres r√©clamations
- ‚úÖ Cr√©er de nouvelles r√©clamations
- ‚úÖ Modifier leurs r√©clamations en attente

**Admins peuvent:**
- ‚úÖ Voir toutes les r√©clamations
- ‚úÖ Approuver/rejeter toutes les r√©clamations

**Emails admin autoris√©s:**
- karpe_25@hotmail.com
- info@h1site.com

```sql
CREATE POLICY "Admins can view all claims"
  ON business_claims FOR SELECT
  TO authenticated
  USING (
    auth.jwt()->>'email' IN ('karpe_25@hotmail.com', 'info@h1site.com')
  );
```

### Protection contre les abus

**Contrainte d'unicit√©:**
```sql
UNIQUE(business_id, user_id)
-- Un utilisateur ne peut r√©clamer la m√™me entreprise qu'une fois
```

**V√©rification c√¥t√© serveur:**
- Approbation automatique via trigger SQL (pas de bypass client)
- Validation du domaine email stricte
- Logs de qui a approuv√©/rejet√© (`verified_by`)

## üìä Workflow Complet

### Cas 1: Auto-approbation (Email Domaine)

```
1. User: info@h1site.com visite /entreprise/h1site
2. Click "R√©clamer votre fiche"
3. Modal d√©tecte: email domain = website domain
4. Affiche message "Approbation automatique disponible!"
5. User clique "Continuer avec Google" ou "Demande manuelle"
6. Backend: INSERT INTO business_claims
7. Trigger: check_email_domain_match() ‚Üí TRUE
8. Trigger: UPDATE status = 'approved'
9. Trigger: UPDATE businesses SET claimed_by = user_id, is_claimed = TRUE
10. Frontend: Affiche "‚úÖ Approuv√© automatiquement!"
11. Page reload ‚Üí Bouton dispara√Æt, user devient owner
```

### Cas 2: Google My Business

```
1. User: jean@gmail.com visite /entreprise/h1site
2. Click "R√©clamer votre fiche"
3. Modal: Pas d'auto-approbation (domaines diff√©rents)
4. User choisit "V√©rification Google My Business"
5. User entre nom, t√©l√©phone, URL Google
6. User modifie description Google avec code
7. Backend: INSERT INTO business_claims (status = 'pending')
8. Frontend: "‚è≥ Demande envoy√©e, admin va v√©rifier"
9. Admin va sur /admin/claims
10. Admin ouvre URL Google, v√©rifie code
11. Admin clique "‚úì Approuver"
12. Backend: UPDATE claim status = 'approved'
13. Backend: UPDATE business claimed_by = user_id
14. User re√ßoit email de confirmation
```

### Cas 3: V√©rification Manuelle

```
1. User: proprietaire@gmail.com visite /entreprise/restaurant-xyz
2. Click "R√©clamer votre fiche"
3. User choisit "Demande manuelle"
4. User remplit: nom, t√©l√©phone, message
5. Message: "Je suis propri√©taire depuis 2015, j'ai les factures"
6. Backend: INSERT INTO business_claims (status = 'pending')
7. Frontend: "‚è≥ Admin va vous contacter"
8. Admin va sur /admin/claims
9. Admin voit message, appelle le t√©l√©phone fourni
10. Admin demande preuve par email
11. User envoie facture r√©cente
12. Admin clique "‚úì Approuver" avec note: "Facture v√©rifi√©e"
13. Backend: UPDATE claim + business
14. User devient owner
```

## üöÄ Prochaines √âtapes

### Avant mass import:

1. **Ex√©cuter la migration:**
   ```sql
   -- Dans Supabase SQL Editor:
   -- Copier/coller le contenu de:
   -- supabase/migration_add_business_claims.sql
   ```

2. **Tester le syst√®me:**
   - Cr√©er un compte test avec email domaine correspondant
   - Tester auto-approbation
   - Cr√©er un compte test gmail
   - Tester v√©rification manuelle
   - V√©rifier interface admin

3. **Importer les entreprises:**
   ```bash
   # Importer par batches de 100-200
   node scripts/import-req-businesses.js --offset=0 --limit=100
   node scripts/import-req-businesses.js --offset=100 --limit=100
   # etc.
   ```

4. **Enrichir avec Google Places:**
   ```bash
   # Ajouter t√©l√©phone, site web, ratings
   node scripts/enrich-req-data.js --limit=100
   ```

### Am√©liorations futures:

- [ ] Notifications email automatiques (approbation/refus)
- [ ] V√©rification SMS (Twilio) pour les cas sans email domaine
- [ ] Dashboard propri√©taire avec statistiques
- [ ] Historique des modifications de fiche
- [ ] Syst√®me de badges "Fiche v√©rifi√©e ‚úì"
- [ ] API Google My Business pour v√©rification automatique
