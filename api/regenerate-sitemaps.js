/**
 * API Endpoint pour r√©g√©n√©rer les sitemaps
 * URL: /api/regenerate-sitemaps
 *
 * Utilisation:
 * - Appel manuel via l'interface admin
 * - Webhook apr√®s ajout d'entreprise
 * - Cron job quotidien
 */

import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

// Cl√© secr√®te pour s√©curiser l'endpoint (√† mettre dans .env)
const REGENERATE_SECRET = process.env.SITEMAP_REGENERATE_SECRET || 'votre-cle-secrete-ici';

export default async function handler(req, res) {
  // V√©rifier la m√©thode
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  // S√©curit√©: v√©rifier le token
  const { secret } = req.body;
  if (secret !== REGENERATE_SECRET) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  try {
    console.log('üó∫Ô∏è  D√©but de la r√©g√©n√©ration des sitemaps...');

    // R√©g√©n√©rer le sitemap fran√ßais
    const { stdout: frOutput } = await execAsync('node scripts/generate-sitemap-all-businesses.js');
    console.log('‚úÖ Sitemap FR g√©n√©r√©');

    // R√©g√©n√©rer le sitemap anglais
    const { stdout: enOutput } = await execAsync('node scripts/generate-sitemap-en-split.js');
    console.log('‚úÖ Sitemap EN g√©n√©r√©');

    return res.status(200).json({
      success: true,
      message: 'Sitemaps r√©g√©n√©r√©s avec succ√®s',
      timestamp: new Date().toISOString(),
      details: {
        french: 'Sitemap fran√ßais r√©g√©n√©r√©',
        english: 'Sitemap anglais r√©g√©n√©r√©'
      }
    });

  } catch (error) {
    console.error('‚ùå Erreur lors de la r√©g√©n√©ration:', error);
    return res.status(500).json({
      success: false,
      error: 'Erreur lors de la r√©g√©n√©ration des sitemaps',
      details: error.message
    });
  }
}
