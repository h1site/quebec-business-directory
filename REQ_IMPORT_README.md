# üè¢ Syst√®me d'Import REQ + R√©clamation de Fiches

## üìñ R√©sum√© Ex√©cutif

Ce syst√®me permet d'importer **des milliers d'entreprises qu√©b√©coises** depuis le Registre des Entreprises du Qu√©bec (REQ) et de permettre aux propri√©taires de **r√©clamer leur fiche** pour en prendre contr√¥le.

### ‚ú® Fonctionnalit√©s

- ‚úÖ **Import en masse** du dataset REQ (150,000+ entreprises gratuites)
- ‚úÖ **Cat√©gorisation automatique** via codes SCIAN (85%+ pr√©cision)
- ‚úÖ **Assignment automatique** R√©gion/MRC bas√© sur ville
- ‚úÖ **Syst√®me de r√©clamation** pour propri√©taires
- ‚úÖ **Badge "V√©rifi√©"** pour fiches r√©clam√©es
- ‚úÖ **100% GRATUIT** (aucun co√ªt API)

---

## üöÄ Quick Start (Test Local)

### 1. Ex√©cuter la migration

Dans **Supabase SQL Editor** :

```sql
-- Copier et ex√©cuter tout le contenu de :
supabase/migration_add_req_import_support.sql
```

Cela cr√©e :
- Colonnes REQ (neq, scian_code, is_claimed, etc.)
- Table `scian_category_mapping` avec ~80 mappings
- Table `business_claims` pour r√©clamations

### 2. Tester avec √©chantillon (30 entreprises)

```bash
# Renommer le fichier sample
cp data/req-entreprises-sample.csv data/req-entreprises.csv

# Importer
node scripts/import-req-businesses.js --limit=30

# Assigner cat√©gories
node scripts/assign-categories-from-scian.js --limit=30
```

### 3. V√©rifier dans Supabase

```sql
-- Voir les entreprises import√©es
SELECT name, city, region, mrc, scian_code, is_claimed
FROM businesses
WHERE data_source = 'req'
LIMIT 10;

-- Voir cat√©gories assign√©es
SELECT
  b.name,
  b.city,
  mc.label_fr as categorie,
  sc.label_fr as sous_categorie
FROM businesses b
JOIN business_categories bc ON bc.business_id = b.id
JOIN sub_categories sc ON sc.id = bc.sub_category_id
JOIN main_categories mc ON mc.id = sc.main_category_id
WHERE b.data_source = 'req';
```

---

## üìä Import Complet (Production)

### 1. T√©l√©charger dataset REQ

üëâ https://www.donneesquebec.ca/recherche/dataset/registre-des-entreprises

1. Cliquez sur "T√©l√©charger" (format CSV)
2. Sauvegardez dans `data/req-entreprises.csv`

### 2. Import complet

```bash
# Import TOUTES les entreprises (~150,000)
node scripts/import-req-businesses.js

# Assignment cat√©gories
node scripts/assign-categories-from-scian.js
```

‚è±Ô∏è **Temps estim√© :** 3-4 heures pour 150,000 entreprises

---

## üìã Architecture du Syst√®me

### Nouvelles colonnes dans `businesses`

| Colonne | Type | Description |
|---------|------|-------------|
| `neq` | VARCHAR(10) | Num√©ro Entreprise Qu√©bec (unique) |
| `is_claimed` | BOOLEAN | Fiche r√©clam√©e par propri√©taire ? |
| `claimed_at` | TIMESTAMP | Date de r√©clamation |
| `data_source` | VARCHAR | 'req', 'google', 'manual' |
| `scian_code` | VARCHAR(10) | Code SCIAN (6 chiffres) |
| `scian_description` | TEXT | Description activit√© |
| `auto_categorized` | BOOLEAN | Cat√©gorie assign√©e auto ? |

### Table `scian_category_mapping`

Mapping entre codes SCIAN et vos cat√©gories.

**Exemples :**

| SCIAN | Description | Cat√©gorie | Sous-cat√©gorie |
|-------|-------------|-----------|----------------|
| 722511 | Restaurants service complet | Restauration | Restaurants |
| 238220 | Plomberie/chauffage | Construction | Plombiers |
| 621210 | Cabinets dentistes | Sant√© | Dentistes |
| 541810 | Agences publicit√© | Services Pro | Agences Marketing |

### Table `business_claims`

Gestion des demandes de r√©clamation.

**Workflow :**
1. User voit fiche non r√©clam√©e (`is_claimed = false`)
2. Clique "R√©clamer cette fiche"
3. Remplit formulaire + upload documents (NEQ, facture, etc.)
4. Status = `'pending'`
5. Admin approuve/rejette
6. Si approuv√© : `owner_id` = user_id, `is_claimed` = true

---

## üéØ Couverture G√©ographique

### Villes support√©es

Le mapping Ville ‚Üí MRC ‚Üí R√©gion couvre **50+ villes principales** :

**Mont√©r√©gie :**
- Vaudreuil-Dorion ‚Üí Vaudreuil-Soulanges
- Longueuil ‚Üí Longueuil
- Brossard ‚Üí Longueuil
- Saint-Jean-sur-Richelieu ‚Üí Le Haut-Richelieu

**Montr√©al :**
- Montr√©al ‚Üí Montr√©al

**Laval :**
- Laval ‚Üí Laval

**Laurentides :**
- Saint-J√©r√¥me ‚Üí La Rivi√®re-du-Nord
- Blainville ‚Üí Th√©r√®se-De Blainville
- Mont-Tremblant ‚Üí Les Laurentides

**Capitale-Nationale :**
- Qu√©bec ‚Üí Qu√©bec
- L√©vis ‚Üí L√©vis (Chaudi√®re-Appalaches)

... et 40+ autres villes

### Ajouter plus de villes

√âditez `scripts/import-req-businesses.js` :

```javascript
const cityToLocation = {
  'Votre-Ville': { mrc: 'Nom-MRC', region: 'Nom-R√©gion' },
  // ...
};
```

Ou √©ditez la migration SQL directement.

---

## üìà Statistiques Attendues

### Import REQ complet

- **Total entreprises** : ~150,000
- **Avec ville reconnue** : ~92% (138,000)
- **Avec code SCIAN** : ~85% (127,500)
- **Cat√©goris√©es auto** : ~72% (108,000)

### Par r√©gion (top 5)

1. **Montr√©al** : ~50,000 entreprises
2. **Mont√©r√©gie** : ~25,000
3. **Capitale-Nationale** : ~20,000
4. **Laval** : ~12,000
5. **Laurentides** : ~10,000

### Par cat√©gorie (top 5)

1. **Commerce de d√©tail** : ~35,000
2. **Services professionnels** : ~28,000
3. **Construction** : ~22,000
4. **Restauration** : ~18,000
5. **Sant√© et bien-√™tre** : ~15,000

---

## üîß Am√©liorer la Cat√©gorisation

### Ajouter des mappings SCIAN

√âditez `supabase/migration_add_req_import_support.sql` :

```sql
INSERT INTO scian_category_mapping (scian_code, scian_digits, description_fr, main_category_id, sub_category_id, confidence_level)
VALUES
  ('NOUVEAU_CODE', 6, 'Description',
   (SELECT id FROM main_categories WHERE slug = 'votre-categorie'),
   (SELECT id FROM sub_categories WHERE slug = 'votre-sous-categorie'),
   95);
```

Puis r√©-ex√©cutez :
```bash
node scripts/assign-categories-from-scian.js
```

### Liste compl√®te des codes SCIAN

üëâ https://www23.statcan.gc.ca/imdb/p3VD_f.pl?Function=getVD&TVD=1181553

---

## üõ°Ô∏è Syst√®me de R√©clamation (√Ä Impl√©menter)

### Frontend Components (Prochaine √©tape)

```
src/components/ClaimBusinessModal.jsx     - Modal de r√©clamation
src/components/VerifiedBadge.jsx          - Badge "V√©rifi√© ‚úì"
src/pages/Dashboard/MyClaims.jsx          - Mes r√©clamations
src/pages/Dashboard/AdminClaims.jsx       - Admin: g√©rer r√©clamations
```

### Modifications BusinessDetails.jsx

```jsx
// Afficher bouton si non r√©clam√©
{!business.is_claimed && user && (
  <button onClick={() => setShowClaimModal(true)}>
    R√©clamer cette fiche
  </button>
)}

// Afficher badge si r√©clam√©
{business.is_claimed && (
  <VerifiedBadge />
)}
```

### Workflow admin

```sql
-- Lister r√©clamations pending
SELECT
  bc.*,
  b.name as business_name,
  b.neq
FROM business_claims bc
JOIN businesses b ON b.id = bc.business_id
WHERE bc.status = 'pending'
ORDER BY bc.created_at DESC;

-- Approuver r√©clamation
UPDATE business_claims
SET status = 'approved', verified_at = NOW()
WHERE id = 'claim-id';

UPDATE businesses
SET owner_id = 'user-id', is_claimed = true, claimed_at = NOW()
WHERE id = 'business-id';
```

---

## üÜö Comparaison Sources de Donn√©es

| Source | Co√ªt | Quantit√© | Donn√©es Riches | R√©clamable |
|--------|------|----------|----------------|------------|
| **REQ** | **Gratuit** ‚úÖ | **150,000+** ‚úÖ | ‚ö†Ô∏è Basiques | ‚úÖ Oui |
| Google Places | $17/1000 | Illimit√© | ‚úÖ Photos/Reviews | ‚ùå Non |
| Manuel | Gratuit | Selon effort | ‚úÖ Complet | ‚ùå N/A |

### Strat√©gie hybride recommand√©e

1. **Import REQ** : Peupler base avec 150k entreprises (gratuit)
2. **R√©clamations** : Propri√©taires enrichissent leurs fiches
3. **Enrichissement Google** : Seulement pour fiches r√©clam√©es

**Co√ªt total :** $0 initial, puis ~$20 par 1000 r√©clamations enrichies

---

## ‚ùì FAQ

### Est-ce l√©gal d'utiliser les donn√©es REQ ?

‚úÖ **Oui, 100% l√©gal.** C'est une initiative de donn√©es ouvertes du gouvernement du Qu√©bec.

### Les entreprises import√©es seront-elles visibles publiquement ?

‚úÖ **Oui.** Elles auront une page publique avec badge "Non r√©clam√©".

### Comment √©viter les doublons avec Google Import ?

V√©rifiez d'abord si NEQ existe :

```javascript
const { data } = await supabase
  .from('businesses')
  .select('id')
  .eq('neq', neq)
  .single();

if (data) {
  // Fusionner ou ignorer
}
```

### Peut-on modifier les donn√©es import√©es ?

‚úÖ **Oui.** Apr√®s r√©clamation, le propri√©taire peut tout modifier.

### Que faire si une ville n'est pas dans le mapping ?

Ajoutez-la dans `cityToLocation` (voir section Couverture G√©ographique).

---

## üìÅ Fichiers Cr√©√©s

```
supabase/
  migration_add_req_import_support.sql   ‚Üê Migration principale

scripts/
  import-req-businesses.js               ‚Üê Script d'import
  assign-categories-from-scian.js        ‚Üê Assignment cat√©gories

data/
  req-entreprises-sample.csv             ‚Üê √âchantillon 30 entreprises (test)
  req-entreprises.csv                    ‚Üê Dataset complet (√† t√©l√©charger)

docs/
  REQ_IMPORT_GUIDE.md                    ‚Üê Guide d√©taill√©

REQ_IMPORT_README.md                     ‚Üê Ce fichier
```

---

## üìû Support

### Dataset REQ
- Email: Groupe.EOS@req.gouv.qc.ca
- Site: https://www.donneesquebec.ca

### Questions techniques
- Cr√©er une issue GitHub
- Consulter `docs/REQ_IMPORT_GUIDE.md`

---

## üéâ Prochaines √âtapes

### Phase 1 : Import (‚úÖ Compl√©t√©)
- [x] Migration SQL
- [x] Script import
- [x] Script cat√©gorisation
- [x] Documentation

### Phase 2 : Interface R√©clamation (üîú √Ä Faire)
- [ ] ClaimBusinessModal.jsx
- [ ] VerifiedBadge.jsx
- [ ] MyClaims.jsx (dashboard user)
- [ ] AdminClaims.jsx (dashboard admin)
- [ ] Syst√®me d'emails

### Phase 3 : Enrichissement (üîú Futur)
- [ ] G√©ocodage automatique (lat/lng)
- [ ] Import Google apr√®s r√©clamation
- [ ] Upload photos
- [ ] Horaires d'ouverture

---

## üìú Licence

- **Dataset REQ** : Licence ouverte Gouvernement du Qu√©bec
- **Scripts** : MIT License

---

**Cr√©√© avec ‚ù§Ô∏è pour le Registre du Qu√©bec**
