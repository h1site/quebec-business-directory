#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

// Cat√©gorie par d√©faut: "Services professionnels"
const DEFAULT_CATEGORY_ID = '944753c0-0ebf-4d74-9168-268fab04fc0d';

async function assignDefaultCategory() {
  console.log('üöÄ Assignment de la cat√©gorie par d√©faut aux businesses sans cat√©gorie...\n');

  try {
    const BATCH_SIZE = 1000;
    let totalUpdated = 0;
    let offset = 0;

    while (true) {
      console.log(`\nüì¶ Batch ${Math.floor(offset / BATCH_SIZE) + 1} (offset: ${offset.toLocaleString()})...`);

      // R√©cup√©rer un batch de businesses sans cat√©gories
      const { data: businesses, error: fetchError } = await supabase
        .from('businesses')
        .select('id')
        .or('categories.is.null,categories.eq.{}')
        .range(offset, offset + BATCH_SIZE - 1);

      if (fetchError) {
        console.error('‚ùå Erreur lors de la r√©cup√©ration:', fetchError);
        break;
      }

      if (!businesses || businesses.length === 0) {
        console.log('\n‚úÖ Plus de businesses √† traiter!');
        break;
      }

      console.log(`   Trouv√© ${businesses.length} businesses sans cat√©gorie`);

      // Mettre √† jour ce batch
      const ids = businesses.map(b => b.id);
      const { error: updateError, data } = await supabase
        .from('businesses')
        .update({ categories: [DEFAULT_CATEGORY_ID] })
        .in('id', ids)
        .select('id');

      if (updateError) {
        console.error('‚ùå Erreur lors de la mise √† jour:', updateError);
        offset += BATCH_SIZE;
        continue;
      }

      const count = data?.length || 0;
      totalUpdated += count;
      console.log(`   ‚úÖ ${count.toLocaleString()} businesses mises √† jour`);
      console.log(`   üìä Total: ${totalUpdated.toLocaleString()} businesses`);

      // Si on a moins que BATCH_SIZE, on a fini
      if (businesses.length < BATCH_SIZE) {
        console.log('\n‚úÖ Dernier batch trait√©!');
        break;
      }

      offset += BATCH_SIZE;

      // Pause pour √©viter de surcharger l'API
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    console.log('\n\n‚úÖ TERMIN√â!');
    console.log(`üìä Total businesses mises √† jour: ${totalUpdated.toLocaleString()}`);

    // V√©rification finale
    const { count: totalWithCategories } = await supabase
      .from('businesses')
      .select('id', { count: 'exact', head: true })
      .not('categories', 'is', null)
      .neq('categories', '[]');

    const { count: totalBusinesses } = await supabase
      .from('businesses')
      .select('id', { count: 'exact', head: true });

    console.log(`\nüéØ R√©sum√© final:`);
    console.log(`   Total businesses: ${totalBusinesses?.toLocaleString()}`);
    console.log(`   Avec cat√©gories: ${totalWithCategories?.toLocaleString()}`);
    console.log(`   Pourcentage: ${((totalWithCategories / totalBusinesses) * 100).toFixed(1)}%`);

  } catch (error) {
    console.error('‚ùå Erreur fatale:', error);
  }
}

assignDefaultCategory();
