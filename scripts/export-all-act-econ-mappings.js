/**
 * Exporter TOUS les mappings ACT_ECON ‚Üí Cat√©gories
 * Codes de 0100 √† 9999
 *
 * Sortie: CSV et tableau format√©
 */

import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '..', '.env') });

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Variables Supabase manquantes!');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

console.log('üìä EXPORT COMPLET: ACT_ECON ‚Üí CAT√âGORIES (0100-9999)\n');
console.log('‚ïê'.repeat(80));

// 1. R√©cup√©rer tous les codes ACT_ECON de la table act_econ_codes
console.log('\n1Ô∏è‚É£ R√©cup√©ration des codes ACT_ECON...\n');

const { data: allCodes, error: codesError } = await supabase
  .from('act_econ_codes')
  .select('code, label_fr')
  .gte('code', 100)
  .lte('code', 9999)
  .order('code');

if (codesError) {
  console.error('‚ùå Erreur:', codesError);
  process.exit(1);
}

console.log(`   ‚úÖ ${allCodes?.length || 0} codes ACT_ECON trouv√©s`);

// 2. R√©cup√©rer toutes les cat√©gories du site
console.log('\n2Ô∏è‚É£ R√©cup√©ration des cat√©gories du site...\n');

const { data: categories } = await supabase
  .from('main_categories')
  .select('id, name_fr, name_en, slug')
  .order('name_fr');

console.log(`   ‚úÖ ${categories?.length || 0} cat√©gories trouv√©es`);

// Cr√©er un map des cat√©gories
const catMap = {};
categories?.forEach(cat => {
  catMap[cat.id] = {
    name_fr: cat.name_fr,
    name_en: cat.name_en,
    slug: cat.slug
  };
});

// 3. R√©cup√©rer les mappings existants
console.log('\n3Ô∏è‚É£ R√©cup√©ration des mappings ACT_ECON ‚Üí Cat√©gories...\n');

const { data: mappings } = await supabase
  .from('act_econ_main_categories')
  .select('act_econ_code, main_category_id')
  .order('act_econ_code');

console.log(`   ‚úÖ ${mappings?.length || 0} mappings trouv√©s`);

// Cr√©er un map des mappings
const mappingMap = {};
mappings?.forEach(m => {
  mappingMap[m.act_econ_code] = m.main_category_id;
});

// 4. Compter combien d'entreprises utilisent chaque code
console.log('\n4Ô∏è‚É£ Comptage des entreprises par code ACT_ECON...\n');

const { data: businessCounts } = await supabase
  .from('businesses')
  .select('act_econ_code')
  .not('act_econ_code', 'is', null)
  .gte('act_econ_code', '0100')
  .lte('act_econ_code', '9999');

const countMap = {};
businessCounts?.forEach(b => {
  const code = parseInt(b.act_econ_code);
  countMap[code] = (countMap[code] || 0) + 1;
});

console.log(`   ‚úÖ Donn√©es de ${businessCounts?.length || 0} entreprises analys√©es`);

// 5. Cr√©er le rapport complet
console.log('\n5Ô∏è‚É£ G√©n√©ration du rapport...\n');

const report = [];
const csvLines = ['Code ACT_ECON,Label FR,Cat√©gorie Mapp√©e (FR),Cat√©gorie Mapp√©e (EN),Slug Cat√©gorie,Nombre Entreprises'];

allCodes?.forEach(code => {
  const categoryId = mappingMap[code.code];
  const category = categoryId ? catMap[categoryId] : null;
  const businessCount = countMap[code.code] || 0;

  const row = {
    code: code.code,
    label_fr: code.label_fr || 'N/A',
    category_fr: category ? category.name_fr : 'NON MAPP√â',
    category_en: category ? category.name_en : 'NOT MAPPED',
    category_slug: category ? category.slug : '',
    business_count: businessCount
  };

  report.push(row);

  // Ligne CSV
  csvLines.push([
    code.code,
    `"${row.label_fr.replace(/"/g, '""')}"`,
    `"${row.category_fr.replace(/"/g, '""')}"`,
    `"${row.category_en.replace(/"/g, '""')}"`,
    row.category_slug,
    row.business_count
  ].join(','));
});

// 6. Sauvegarder en CSV
const csvPath = path.join(__dirname, '..', 'act-econ-mappings-export.csv');
fs.writeFileSync(csvPath, csvLines.join('\n'), 'utf-8');

console.log(`   ‚úÖ Fichier CSV cr√©√©: act-econ-mappings-export.csv`);

// 7. Afficher statistiques
console.log('\n' + '‚ïê'.repeat(80));
console.log('\nüìä STATISTIQUES:\n');

const mapped = report.filter(r => r.category_slug !== '');
const notMapped = report.filter(r => r.category_slug === '');
const withBusinesses = report.filter(r => r.business_count > 0);

console.log(`   Total codes ACT_ECON: ${report.length}`);
console.log(`   Codes mapp√©s √† une cat√©gorie: ${mapped.length}`);
console.log(`   Codes NON mapp√©s: ${notMapped.length}`);
console.log(`   Codes utilis√©s par des entreprises: ${withBusinesses.length}`);

// 8. Top 20 codes les plus utilis√©s
console.log('\nüìã TOP 20 CODES ACT_ECON LES PLUS UTILIS√âS:\n');

const top20 = report
  .filter(r => r.business_count > 0)
  .sort((a, b) => b.business_count - a.business_count)
  .slice(0, 20);

top20.forEach((row, i) => {
  console.log(`${(i + 1).toString().padStart(2)}. Code ${row.code} - ${row.label_fr}`);
  console.log(`    ‚Üí ${row.category_fr}`);
  console.log(`    ${row.business_count.toLocaleString()} entreprises`);
  console.log('');
});

// 9. Codes non mapp√©s avec beaucoup d'entreprises
console.log('\n‚ö†Ô∏è  CODES NON MAPP√âS AVEC LE PLUS D\'ENTREPRISES:\n');

const unmappedWithBusinesses = report
  .filter(r => r.category_slug === '' && r.business_count > 0)
  .sort((a, b) => b.business_count - a.business_count)
  .slice(0, 10);

if (unmappedWithBusinesses.length === 0) {
  console.log('   ‚úÖ Tous les codes utilis√©s sont mapp√©s!');
} else {
  unmappedWithBusinesses.forEach((row, i) => {
    console.log(`${(i + 1).toString().padStart(2)}. Code ${row.code} - ${row.label_fr}`);
    console.log(`    ‚ùå NON MAPP√â - ${row.business_count.toLocaleString()} entreprises`);
    console.log('');
  });
}

console.log('\n' + '‚ïê'.repeat(80));
console.log('\n‚úÖ EXPORT TERMIN√â!\n');
console.log(`üìÑ Fichier CSV: act-econ-mappings-export.csv`);
console.log(`   (${report.length} lignes export√©es)`);
