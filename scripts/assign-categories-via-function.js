import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.VITE_SUPABASE_ANON_KEY
);

console.log('üè∑Ô∏è  ASSIGNMENT DES CAT√âGORIES VIA FONCTION SQL\n');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

async function assignCategories() {
  console.log('üöÄ Appel de la fonction SQL c√¥t√© serveur...\n');
  console.log('‚è∞ Cette op√©ration peut prendre 1-2 minutes...\n');

  try {
    // Appeler la fonction SQL
    const { data, error } = await supabase.rpc('assign_categories_from_act_econ');

    if (error) {
      console.error('‚ùå Erreur:', error);
      return;
    }

    console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('‚úÖ TERMIN√â!');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    if (data && data.length > 0) {
      const result = data[0];
      console.log('üìä R√©sultats:');
      console.log(`   Codes ACT_ECON trait√©s: ${result.codes_processed}`);
      console.log(`   Businesses mis √† jour: ${result.total_updated?.toLocaleString()}`);
    }

    console.log('\nüîç V√©rification des statistiques...\n');

    // V√©rifier les r√©sultats
    const { count: totalWithActEcon } = await supabase
      .from('businesses')
      .select('*', { count: 'exact', head: true })
      .not('act_econ_code', 'is', null);

    // √âchantillon pour compter ceux avec cat√©gories
    const { data: sample } = await supabase
      .from('businesses')
      .select('categories')
      .not('act_econ_code', 'is', null)
      .range(0, 9999);

    const withCategories = sample?.filter(b => b.categories && b.categories.length > 0).length || 0;
    const estimated = Math.round((withCategories / 10000) * totalWithActEcon);
    const percentage = ((estimated / totalWithActEcon) * 100).toFixed(1);

    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìä STATISTIQUES FINALES:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`Total avec ACT_ECON: ${totalWithActEcon?.toLocaleString()}`);
    console.log(`√âchantillon (10K): ${withCategories.toLocaleString()} avec cat√©gories`);
    console.log(`Estimation: ${estimated.toLocaleString()} avec cat√©gories`);
    console.log(`Taux: ${percentage}%`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

    // Exemples
    const { data: examples } = await supabase
      .from('businesses')
      .select('name, act_econ_code, categories')
      .not('act_econ_code', 'is', null)
      .not('categories', 'eq', '[]')
      .limit(5);

    console.log('üìã Exemples de businesses avec cat√©gories:\n');
    examples?.forEach(b => {
      console.log(`  ‚úÖ ${b.name}`);
      console.log(`     ACT_ECON: ${b.act_econ_code} | ${b.categories?.length || 0} cat√©gorie(s)`);
    });

    console.log('\n‚ú® Assignment termin√© avec succ√®s!\n');

  } catch (err) {
    console.error('‚ùå Exception:', err);
  }
}

assignCategories();
