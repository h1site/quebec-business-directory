/**
 * Script d'import des entreprises depuis le Registre des Entreprises du Qu√©bec (REQ)
 *
 * PR√âREQUIS:
 * 1. T√©l√©charger le dataset depuis: https://www.donneesquebec.ca/recherche/dataset/registre-des-entreprises
 * 2. Placer le fichier CSV dans: data/req-entreprises.csv
 * 3. Ex√©cuter la migration: supabase/migration_add_req_import_support.sql
 *
 * UTILISATION:
 * node scripts/import-req-businesses.js
 *
 * OPTIONS:
 * --limit=1000    Limiter √† 1000 entreprises (pour test)
 * --dry-run       Afficher les donn√©es sans les ins√©rer
 */

import fs from 'fs';
import path from 'path';
import csv from 'csv-parser';
import { createClient } from '@supabase/supabase-js';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Configuration Supabase
const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Variables d\'environnement Supabase manquantes!');
  console.error('   VITE_SUPABASE_URL:', supabaseUrl ? '‚úì' : '‚úó');
  console.error('   SUPABASE_SERVICE_KEY ou VITE_SUPABASE_ANON_KEY:', supabaseKey ? '‚úì' : '‚úó');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Arguments en ligne de commande
const args = process.argv.slice(2);
const limitArg = args.find(arg => arg.startsWith('--limit='));
const limit = limitArg ? parseInt(limitArg.split('=')[1]) : Infinity;
const offsetArg = args.find(arg => arg.startsWith('--offset='));
const offset = offsetArg ? parseInt(offsetArg.split('=')[1]) : 0;
const dryRun = args.includes('--dry-run');

console.log('üöÄ Import des entreprises depuis le REQ');
console.log('üìä Configuration:', { limit, offset, dryRun });

/**
 * Mapping Ville ‚Üí MRC ‚Üí R√©gion
 * R√©utilise la logique de migration_add_mrc_to_businesses.sql
 */
const cityToLocation = {
  // Mont√©r√©gie
  'Vaudreuil-Dorion': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Vaudreuil-sur-le-Lac': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'L\'√éle-Perrot': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Notre-Dame-de-l\'√éle-Perrot': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Pincourt': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Hudson': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Saint-Lazare': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Longueuil': { mrc: 'Longueuil', region: 'Mont√©r√©gie' },
  'Brossard': { mrc: 'Longueuil', region: 'Mont√©r√©gie' },
  'Saint-Lambert': { mrc: 'Longueuil', region: 'Mont√©r√©gie' },
  'Boucherville': { mrc: 'Longueuil', region: 'Mont√©r√©gie' },
  'Saint-Jean-sur-Richelieu': { mrc: 'Le Haut-Richelieu', region: 'Mont√©r√©gie' },
  'Chambly': { mrc: 'La Vall√©e-du-Richelieu', region: 'Mont√©r√©gie' },
  'Saint-Hyacinthe': { mrc: 'Les Maskoutains', region: 'Mont√©r√©gie' },
  'Granby': { mrc: 'La Haute-Yamaska', region: 'Mont√©r√©gie' },
  'Salaberry-de-Valleyfield': { mrc: 'Beauharnois-Salaberry', region: 'Mont√©r√©gie' },
  'Ch√¢teauguay': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'La Prairie': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'Candiac': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'Sainte-Julie': { mrc: 'Marguerite-D\'Youville', region: 'Mont√©r√©gie' },
  'Varennes': { mrc: 'Marguerite-D\'Youville', region: 'Mont√©r√©gie' },
  'Sorel-Tracy': { mrc: 'Pierre-De Saurel', region: 'Mont√©r√©gie' },

  // Montr√©al
  'Montr√©al': { mrc: 'Montr√©al', region: 'Montr√©al' },
  'Montreal': { mrc: 'Montr√©al', region: 'Montr√©al' },

  // Laval
  'Laval': { mrc: 'Laval', region: 'Laval' },

  // Laurentides
  'Saint-J√©r√¥me': { mrc: 'La Rivi√®re-du-Nord', region: 'Laurentides' },
  'Blainville': { mrc: 'Th√©r√®se-De Blainville', region: 'Laurentides' },
  'Sainte-Th√©r√®se': { mrc: 'Th√©r√®se-De Blainville', region: 'Laurentides' },
  'Boisbriand': { mrc: 'Th√©r√®se-De Blainville', region: 'Laurentides' },
  'Mirabel': { mrc: 'Mirabel', region: 'Laurentides' },
  'Saint-Eustache': { mrc: 'Deux-Montagnes', region: 'Laurentides' },
  'Sainte-Agathe-des-Monts': { mrc: 'Les Laurentides', region: 'Laurentides' },
  'Mont-Tremblant': { mrc: 'Les Laurentides', region: 'Laurentides' },

  // Lanaudi√®re
  'Terrebonne': { mrc: 'Les Moulins', region: 'Lanaudi√®re' },
  'Mascouche': { mrc: 'Les Moulins', region: 'Lanaudi√®re' },
  'Repentigny': { mrc: 'L\'Assomption', region: 'Lanaudi√®re' },
  'L\'Assomption': { mrc: 'L\'Assomption', region: 'Lanaudi√®re' },
  'Joliette': { mrc: 'Joliette', region: 'Lanaudi√®re' },

  // Capitale-Nationale
  'Qu√©bec': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'Quebec': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'L√©vis': { mrc: 'L√©vis', region: 'Chaudi√®re-Appalaches' },

  // Outaouais
  'Gatineau': { mrc: 'Gatineau', region: 'Outaouais' },

  // Estrie
  'Sherbrooke': { mrc: 'Sherbrooke', region: 'Estrie' },

  // Mauricie
  'Trois-Rivi√®res': { mrc: 'Trois-Rivi√®res', region: 'Mauricie' },
  'Shawinigan': { mrc: 'Shawinigan', region: 'Mauricie' },

  // Saguenay-Lac-Saint-Jean
  'Saguenay': { mrc: 'Saguenay', region: 'Saguenay-Lac-Saint-Jean' },
  'Alma': { mrc: 'Lac-Saint-Jean-Est', region: 'Saguenay-Lac-Saint-Jean' },
  'Roberval': { mrc: 'Le Domaine-du-Roy', region: 'Saguenay-Lac-Saint-Jean' },
  'Dolbeau-Mistassini': { mrc: 'Maria-Chapdelaine', region: 'Saguenay-Lac-Saint-Jean' },
  'Saint-F√©licien': { mrc: 'Le Domaine-du-Roy', region: 'Saguenay-Lac-Saint-Jean' },

  // Abitibi-T√©miscamingue
  'Rouyn-Noranda': { mrc: 'Rouyn-Noranda', region: 'Abitibi-T√©miscamingue' },
  'Val-d\'Or': { mrc: 'La Vall√©e-de-l\'Or', region: 'Abitibi-T√©miscamingue' },
  'Amos': { mrc: 'Abitibi', region: 'Abitibi-T√©miscamingue' },

  // C√¥te-Nord
  'Sept-√éles': { mrc: 'Sept-Rivi√®res', region: 'C√¥te-Nord' },
  'Baie-Comeau': { mrc: 'Manicouagan', region: 'C√¥te-Nord' },
  'Port-Cartier': { mrc: 'Sept-Rivi√®res', region: 'C√¥te-Nord' },

  // Gasp√©sie-√éles-de-la-Madeleine
  'Gasp√©': { mrc: 'La C√¥te-de-Gasp√©', region: 'Gasp√©sie-√éles-de-la-Madeleine' },
  'Rimouski': { mrc: 'Rimouski-Neigette', region: 'Bas-Saint-Laurent' },
  'Matane': { mrc: 'La Matanie', region: 'Bas-Saint-Laurent' },
  'Rivi√®re-du-Loup': { mrc: 'Rivi√®re-du-Loup', region: 'Bas-Saint-Laurent' },

  // Chaudi√®re-Appalaches
  'L√©vis': { mrc: 'L√©vis', region: 'Chaudi√®re-Appalaches' },
  'Thetford Mines': { mrc: 'Les Appalaches', region: 'Chaudi√®re-Appalaches' },
  'Saint-Georges': { mrc: 'Beauce-Sartigan', region: 'Chaudi√®re-Appalaches' },
  'Montmagny': { mrc: 'Montmagny', region: 'Chaudi√®re-Appalaches' },
  'Lac-Etchemin': { mrc: 'Les Etchemins', region: 'Chaudi√®re-Appalaches' },

  // Centre-du-Qu√©bec
  'Drummondville': { mrc: 'Drummondville', region: 'Centre-du-Qu√©bec' },
  'Victoriaville': { mrc: 'Arthabaska', region: 'Centre-du-Qu√©bec' },
  'Nicolet': { mrc: 'Nicolet-Yamaska', region: 'Centre-du-Qu√©bec' },

  // Mont√©r√©gie - Plus de villes
  'Beloeil': { mrc: 'La Vall√©e-du-Richelieu', region: 'Mont√©r√©gie' },
  'Saint-Bruno-de-Montarville': { mrc: 'La Vall√©e-du-Richelieu', region: 'Mont√©r√©gie' },
  'Saint-Basile-le-Grand': { mrc: 'Marguerite-D\'Youville', region: 'Mont√©r√©gie' },
  'Vaudreuil': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Rigaud': { mrc: 'Vaudreuil-Soulanges', region: 'Mont√©r√©gie' },
  'Pointe-Claire': { mrc: 'Montr√©al', region: 'Montr√©al' },
  'Dollard-des-Ormeaux': { mrc: 'Montr√©al', region: 'Montr√©al' },
  'Beaconsfield': { mrc: 'Montr√©al', region: 'Montr√©al' },
  'Kirkland': { mrc: 'Montr√©al', region: 'Montr√©al' },
  'Saint-Constant': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'Delson': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'Mercier': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'Beauharnois': { mrc: 'Beauharnois-Salaberry', region: 'Mont√©r√©gie' },
  'Huntingdon': { mrc: 'Le Haut-Saint-Laurent', region: 'Mont√©r√©gie' },
  'Marieville': { mrc: 'Rouville', region: 'Mont√©r√©gie' },
  'Mont-Saint-Hilaire': { mrc: 'La Vall√©e-du-Richelieu', region: 'Mont√©r√©gie' },
  'Verch√®res': { mrc: 'Marguerite-D\'Youville', region: 'Mont√©r√©gie' },
  'Contrecoeur': { mrc: 'Marguerite-D\'Youville', region: 'Mont√©r√©gie' },
  'Saint-Amable': { mrc: 'Marguerite-D\'Youville', region: 'Mont√©r√©gie' },
  'Cowansville': { mrc: 'Brome-Missisquoi', region: 'Mont√©r√©gie' },

  // Laurentides - Plus de villes
  'Rosem√®re': { mrc: 'Th√©r√®se-De Blainville', region: 'Laurentides' },
  'Lorraine': { mrc: 'Th√©r√®se-De Blainville', region: 'Laurentides' },
  'Bois-des-Filion': { mrc: 'Th√©r√®se-De Blainville', region: 'Laurentides' },
  'Deux-Montagnes': { mrc: 'Deux-Montagnes', region: 'Laurentides' },
  'Saint-Joseph-du-Lac': { mrc: 'Deux-Montagnes', region: 'Laurentides' },
  'Oka': { mrc: 'Deux-Montagnes', region: 'Laurentides' },
  'Sainte-Ad√®le': { mrc: 'Les Pays-d\'en-Haut', region: 'Laurentides' },
  'Sainte-Sophie': { mrc: 'La Rivi√®re-du-Nord', region: 'Laurentides' },
  'Pr√©vost': { mrc: 'La Rivi√®re-du-Nord', region: 'Laurentides' },
  'Mont-Tremblant': { mrc: 'Les Laurentides', region: 'Laurentides' },
  'MONT-TREMBLANT': { mrc: 'Les Laurentides', region: 'Laurentides' },

  // Lanaudi√®re - Plus de villes
  'L\'√âpiphanie': { mrc: 'L\'Assomption', region: 'Lanaudi√®re' },
  'Lavaltrie': { mrc: 'D\'Autray', region: 'Lanaudi√®re' },
  'Berthierville': { mrc: 'D\'Autray', region: 'Lanaudi√®re' },
  'Saint-Charles-Borrom√©e': { mrc: 'Joliette', region: 'Lanaudi√®re' },
  'Rawdon': { mrc: 'Matawinie', region: 'Lanaudi√®re' },

  // Capitale-Nationale - Plus de villes
  'Sainte-Foy': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'Beauport': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'Charlesbourg': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'L\'Ancienne-Lorette': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'Saint-Augustin-de-Desmaures': { mrc: 'Qu√©bec', region: 'Capitale-Nationale' },
  'Donnacona': { mrc: 'Portneuf', region: 'Capitale-Nationale' },
  'Pont-Rouge': { mrc: 'Portneuf', region: 'Capitale-Nationale' },

  // Mauricie - Plus de villes
  'Grand-M√®re': { mrc: 'Shawinigan', region: 'Mauricie' },
  'La Tuque': { mrc: 'La Tuque', region: 'Mauricie' },
  'Louiseville': { mrc: 'Maskinong√©', region: 'Mauricie' },

  // Estrie - Plus de villes
  'Magog': { mrc: 'Memphr√©magog', region: 'Estrie' },
  'Bromont': { mrc: 'Brome-Missisquoi', region: 'Estrie' },
  'Cowansville': { mrc: 'Brome-Missisquoi', region: 'Estrie' },
  'Asbestos': { mrc: 'Les Sources', region: 'Estrie' },

  // Outaouais - Plus de villes
  'Aylmer': { mrc: 'Gatineau', region: 'Outaouais' },
  'Hull': { mrc: 'Gatineau', region: 'Outaouais' },
  'Buckingham': { mrc: 'Gatineau', region: 'Outaouais' },
  'Masson-Angers': { mrc: 'Gatineau', region: 'Outaouais' },
  'Val-des-Monts': { mrc: 'Les Collines-de-l\'Outaouais', region: 'Outaouais' },
  'Chelsea': { mrc: 'Les Collines-de-l\'Outaouais', region: 'Outaouais' },

  // Variantes de noms de villes (avec St, St-, etc.)
  'St-Jean sur Richelieu': { mrc: 'Le Haut-Richelieu', region: 'Mont√©r√©gie' },
  'St-J√©r√¥me': { mrc: 'La Rivi√®re-du-Nord', region: 'Laurentides' },
  'St-C√©saire': { mrc: 'Rouville', region: 'Mont√©r√©gie' },
  'St-Isidore': { mrc: 'Roussillon', region: 'Mont√©r√©gie' },
  'St-Nazaire': { mrc: 'Lac-Saint-Jean-Est', region: 'Saguenay-Lac-Saint-Jean' },
  'MONT-ST-GR√âGOIRE': { mrc: 'Le Haut-Richelieu', region: 'Mont√©r√©gie' },

  // Variantes avec apostrophes et espaces
  'Val d\'Or': { mrc: 'La Vall√©e-de-l\'Or', region: 'Abitibi-T√©miscamingue' },
  'Sainte-Marthe-sur-le-Lac': { mrc: 'Deux-Montagnes', region: 'Laurentides' },
  'Sainte-M√©lanie': { mrc: 'Joliette', region: 'Lanaudi√®re' },
  'Saint-N√©r√©e-de-Bellechasse': { mrc: 'Bellechasse', region: 'Chaudi√®re-Appalaches' },
  'SAINT-√âLIE': { mrc: 'Les Maskoutains', region: 'Mont√©r√©gie' },

  // Estrie
  'Valcourt': { mrc: 'Le Val-Saint-Fran√ßois', region: 'Estrie' },
  'Cascap√©dia--Saint-Jules': { mrc: 'Avignon', region: 'Gasp√©sie-√éles-de-la-Madeleine' },

  // Bas-Saint-Laurent / Gasp√©sie
  'CAUSAPSCAL': { mrc: 'La Matap√©dia', region: 'Bas-Saint-Laurent' },
  'RIVI√àRE-AU-RENARD': { mrc: 'La C√¥te-de-Gasp√©', region: 'Gasp√©sie-√éles-de-la-Madeleine' }
};

/**
 * G√©n√©rer un slug SEO-friendly bas√© sur le nom de l'entreprise
 * Retourne slug simple d'abord, ajoute ville si collision d√©tect√©e ult√©rieurement
 */
function generateBaseSlug(name, city = '') {
  if (!name) return null;

  const base = name
    .toLowerCase()
    .normalize('NFD') // D√©composer les accents
    .replace(/[\u0300-\u036f]/g, '') // Retirer les accents
    .replace(/[^a-z0-9]+/g, '-') // Remplacer caract√®res sp√©ciaux par tirets
    .replace(/(^-|-$)/g, '') // Retirer tirets d√©but/fin
    .substring(0, 50); // Limiter longueur

  // Normaliser la ville pour le slug
  const citySlug = city
    ? city
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
    : '';

  return { base, citySlug };
}

/**
 * G√©n√©rer un slug unique en v√©rifiant les doublons
 * Strat√©gie: nom ‚Üí nom-ville (si doublon) ‚Üí nom-ville-2 (si encore doublon)
 */
async function generateUniqueSlug(name, city, neq, etablissement) {
  const { base, citySlug } = generateBaseSlug(name, city);

  // Tenter d'abord le slug simple
  let slug = base;
  let { data: existing } = await supabase
    .from('businesses')
    .select('id')
    .eq('slug', slug)
    .single();

  // Si collision, ajouter la ville
  if (existing) {
    slug = citySlug ? `${base}-${citySlug}` : base;

    const { data: existingWithCity } = await supabase
      .from('businesses')
      .select('id')
      .eq('slug', slug)
      .single();

    // Si encore collision, ajouter suffixe num√©rique
    if (existingWithCity) {
      let counter = 2;
      let finalSlug = `${slug}-${counter}`;

      while (true) {
        const { data: check } = await supabase
          .from('businesses')
          .select('id')
          .eq('slug', finalSlug)
          .single();

        if (!check) {
          slug = finalSlug;
          break;
        }
        counter++;
        finalSlug = `${slug}-${counter}`;
      }
    }
  }

  return slug;
}

/**
 * Trouver la cat√©gorie bas√©e sur le code SCIAN
 */
async function findCategoryByScian(scianCode) {
  if (!scianCode) {
    return { main_category_id: null, sub_category_id: null, confidence: 0 };
  }

  // Chercher mapping exact en commen√ßant par le code le plus pr√©cis (6 ‚Üí 5 ‚Üí 4 ‚Üí 3 ‚Üí 2 chiffres)
  for (let digits = scianCode.length; digits >= 2; digits--) {
    const code = scianCode.substring(0, digits);

    const { data, error } = await supabase
      .from('scian_category_mapping')
      .select('main_category_id, sub_category_id, confidence_level')
      .eq('scian_code', code)
      .order('confidence_level', { ascending: false })
      .limit(1)
      .single();

    if (data && !error) {
      return {
        main_category_id: data.main_category_id,
        sub_category_id: data.sub_category_id,
        confidence: data.confidence_level
      };
    }
  }

  return { main_category_id: null, sub_category_id: null, confidence: 0 };
}

/**
 * Ins√©rer un batch d'entreprises (en ignorant les doublons NEQ + √©tablissement)
 */
async function batchInsert(businesses) {
  if (dryRun) {
    console.log(`üîç [DRY-RUN] Affichage de ${businesses.length} entreprises:`);
    console.table(businesses.slice(0, 3)); // Afficher 3 exemples
    return { count: businesses.length, errors: [] };
  }

  // V√©rifier quels NEQ + etablissement_number existent d√©j√†
  const neqs = businesses.map(b => b.neq).filter(Boolean);
  const { data: existing } = await supabase
    .from('businesses')
    .select('neq, etablissement_number')
    .in('neq', neqs);

  // Cr√©er un Set avec cl√© composite "neq-etab"
  const existingKeys = new Set(
    (existing || []).map(b => `${b.neq}-${b.etablissement_number}`)
  );

  // Filtrer les entreprises qui n'existent pas d√©j√†
  const newBusinesses = businesses.filter(
    b => !existingKeys.has(`${b.neq}-${b.etablissement_number}`)
  );

  if (newBusinesses.length === 0) {
    console.log('‚ö†Ô∏è  Toutes les entreprises de ce batch existent d√©j√†');
    return { count: 0, errors: [], skipped: businesses.length };
  }

  if (existingKeys.size > 0) {
    const skipped = businesses.length - newBusinesses.length;
    console.log(`‚è≠Ô∏è  Ignor√© ${skipped} entreprise(s) d√©j√† existante(s)`);
  }

  // G√©rer les doublons de slugs DANS LE BATCH
  const slugCounts = {};
  const finalBusinesses = newBusinesses.map(business => {
    let finalSlug = business.slug;

    // Si ce slug appara√Æt plusieurs fois dans le batch, ajouter ville
    if (slugCounts[finalSlug]) {
      slugCounts[finalSlug]++;
      const citySlug = business.city
        ? business.city.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')
        : '';
      finalSlug = citySlug ? `${business.slug}-${citySlug}` : `${business.slug}-${slugCounts[finalSlug]}`;
    } else {
      slugCounts[finalSlug] = 1;
    }

    return { ...business, slug: finalSlug };
  });

  const { data, error} = await supabase
    .from('businesses')
    .insert(finalBusinesses)
    .select('id, neq, name');

  if (error) {
    console.error('‚ùå Erreur lors de l\'insertion:', error.message);
    const skipped = businesses.length - finalBusinesses.length;
    return { count: 0, errors: [error], skipped: skipped };
  }

  const skipped = businesses.length - finalBusinesses.length;
  return { count: data.length, errors: [], skipped: skipped };
}

/**
 * Assigner les cat√©gories bas√©es sur SCIAN
 */
async function assignCategoryToBusinesses(businessIds, subCategoryId) {
  if (!subCategoryId || dryRun) return;

  const relations = businessIds.map(businessId => ({
    business_id: businessId,
    sub_category_id: subCategoryId,
    is_primary: true
  }));

  const { error } = await supabase
    .from('business_categories')
    .insert(relations);

  if (error) {
    console.error('‚ö†Ô∏è Erreur lors de l\'assignation des cat√©gories:', error.message);
  }
}

/**
 * Fonction principale d'import
 */
async function importREQData() {
  const csvPath = path.join(__dirname, '..', 'data', 'req-entreprises.csv');

  if (!fs.existsSync(csvPath)) {
    console.error('‚ùå Fichier CSV introuvable:', csvPath);
    console.log('');
    console.log('üì• Pour obtenir le fichier:');
    console.log('   1. Visitez: https://www.donneesquebec.ca/recherche/dataset/registre-des-entreprises');
    console.log('   2. T√©l√©chargez le fichier CSV');
    console.log('   3. Placez-le dans: data/req-entreprises.csv');
    console.log('');
    process.exit(1);
  }

  console.log('üìÇ Lecture du fichier CSV:', csvPath);

  let totalRead = 0;
  let totalInserted = 0;
  let totalErrors = 0;
  let totalSkipped = 0;
  let batch = [];
  const batchSize = 100; // Ins√©rer par batch de 100 pour performance

  // Statistiques
  const stats = {
    withLocation: 0,
    withCategory: 0,
    withScian: 0
  };

  return new Promise((resolve, reject) => {
    let rowIndex = 0;

    fs.createReadStream(csvPath)
      .pipe(csv())
      .on('data', async (row) => {
        rowIndex++;

        // Skip rows before offset
        if (rowIndex <= offset) return;

        // Stop after limit
        if (totalRead >= limit) return;

        totalRead++;

        // Parser les champs du format officiel REQ Etablissements.csv
        // Note: G√©rer BOM (Byte Order Mark) dans le CSV qui peut pr√©fixer NEQ
        const neq = row.NEQ || row['ÔªøNEQ'] || row[Object.keys(row)[0]]; // G√®re BOM
        const etablissement = row.NO_SUF_ETAB || '1'; // Num√©ro d'√©tablissement (pour multi-√©tablissements)
        const name = row.NOM_ETAB || 'Entreprise sans nom';
        const addressLine1 = row.LIGN1_ADR || '';
        const addressLine2 = row.LIGN2_ADR || ''; // Contient "Ville (Qu√©bec)"
        const lign3 = row.LIGN3_ADR || ''; // Parfois le code postal est ici
        const lign4 = row.LIGN4_ADR || ''; // Ou ici
        const scianCode = row.COD_ACT_ECON || row.COD_ACT_ECON2;
        const scianDesc = row.DESC_ACT_ECON_ETAB || row.DESC_ACT_ECON_ETAB2;

        if (!neq) {
          console.log('‚ö†Ô∏è Ligne sans NEQ ignor√©e:', row);
          return;
        }

        // Parser ville et code postal
        let city = '';
        let postalCode = '';

        // Extraire ville depuis LIGN2_ADR (format: "Montr√©al (Qu√©bec)" ou "MONT-TREMBLANT QC")
        if (addressLine2) {
          // Extraire ville (avant "(Qu√©bec)" ou "(QC)" ou "QC")
          const cityMatch = addressLine2.match(/^([^(]+?)\s*(?:\((?:Qu√©bec|QC)\)|\s+QC)?$/i);
          if (cityMatch) {
            city = cityMatch[1].trim();
          } else {
            // Fallback: prendre toute la ligne si pas de pattern match
            city = addressLine2.replace(/\s*\((?:Qu√©bec|QC)\)|\s+QC/gi, '').trim();
          }
        }

        // Extraire code postal depuis LIGN3_ADR, LIGN4_ADR ou LIGN2_ADR
        const postalSources = [lign4, lign3, addressLine2];
        for (const source of postalSources) {
          if (source) {
            // Format: H1J1Z1 ou H1J 1Z1 ou "H1J 1Z1"
            const postalMatch = source.match(/([A-Z]\d[A-Z]\s?\d[A-Z]\d)/i);
            if (postalMatch) {
              postalCode = postalMatch[1].replace(/\s/g, '').toUpperCase();
              break;
            }
          }
        }

        // Filtrer: seulement √©tablissements principaux
        const isPrincipal = row.IND_ETAB_PRINC === 'O';
        const status = 'actif'; // Etablissements.csv contient seulement actifs

        // Filtrer: seulement entreprises actives
        if (status && status.toLowerCase().includes('inactif')) {
          return;
        }

        // Filtrer: ignorer les entreprises "9000-XXXX QU√âBEC INC."
        // Ce sont des num√©ros g√©n√©riques sans nom significatif
        if (name && /^9\d{3}-\d{4}\s+QU[√âE]BEC\s+INC/i.test(name)) {
          return;
        }

        // Filtrer: ignorer les entreprises commen√ßant par "3XXX-XXXX QU√âBEC INC." ou "3XXXXXXX CANADA INC."
        // Ce sont aussi des num√©ros de corporation g√©n√©riques
        if (name && /^3\d{3,7}[-\s]?\d{0,4}\s+(QU[√âE]BEC|CANADA)\s+INC/i.test(name)) {
          return;
        }

        // Trouver MRC et r√©gion
        const location = cityToLocation[city] || { mrc: null, region: null };
        if (location.mrc) stats.withLocation++;
        if (scianCode) stats.withScian++;

        // G√©n√©rer slug unique (async)
        const slug = await generateUniqueSlug(name, city, neq, etablissement);

        const business = {
          neq: neq,
          etablissement_number: etablissement,
          name: name,
          address: addressLine1,
          city: city,
          mrc: location.mrc,
          region: location.region,
          postal_code: postalCode,
          province: 'QC',
          scian_code: scianCode,
          scian_description: scianDesc,
          slug: slug,
          data_source: 'req',
          is_claimed: false,
          owner_id: null,
          auto_categorized: scianCode ? true : false,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };

        batch.push(business);

        // Ins√©rer par batch
        if (batch.length >= batchSize) {
          const result = await batchInsert([...batch]);
          totalInserted += result.count;
          totalErrors += result.errors.length;
          totalSkipped += result.skipped || 0;

          console.log(`‚úÖ Import√© ${totalInserted}/${totalRead} entreprises (${Math.round(totalInserted/totalRead*100)}%) | Ignor√©: ${totalSkipped}`);

          batch = [];
        }

        // Log progression
        if (totalRead % 500 === 0) {
          console.log(`üìä Progression: ${totalRead} entreprises lues`);
          console.log(`   - Avec location: ${stats.withLocation} (${Math.round(stats.withLocation/totalRead*100)}%)`);
          console.log(`   - Avec SCIAN: ${stats.withScian} (${Math.round(stats.withScian/totalRead*100)}%)`);
        }
      })
      .on('end', async () => {
        // Ins√©rer dernier batch
        if (batch.length > 0) {
          const result = await batchInsert(batch);
          totalInserted += result.count;
          totalSkipped += result.skipped || 0;
        }

        console.log('');
        console.log('‚úÖ Import termin√©!');
        console.log('‚ïê'.repeat(50));
        console.log(`üìä Statistiques:`);
        console.log(`   Total lu:        ${totalRead}`);
        console.log(`   Total ins√©r√©:    ${totalInserted}`);
        console.log(`   Total ignor√©:    ${totalSkipped} (d√©j√† existants)`);
        console.log(`   Erreurs:         ${totalErrors}`);
        console.log(`   Avec location:   ${stats.withLocation} (${Math.round(stats.withLocation/totalRead*100)}%)`);
        console.log(`   Avec SCIAN:      ${stats.withScian} (${Math.round(stats.withScian/totalRead*100)}%)`);
        console.log('‚ïê'.repeat(50));
        console.log('');
        console.log('‚è≠Ô∏è  Prochaine √©tape: Assigner les cat√©gories bas√©es sur SCIAN');
        console.log('   node scripts/assign-categories-from-scian.js');

        resolve();
      })
      .on('error', (error) => {
        console.error('‚ùå Erreur lors de la lecture du CSV:', error);
        reject(error);
      });
  });
}

// Ex√©cuter l'import
importREQData()
  .then(() => {
    console.log('üéâ Script termin√© avec succ√®s!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('üí• Erreur fatale:', error);
    process.exit(1);
  });
