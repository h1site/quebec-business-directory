/**
 * Script de validation des donn√©es REQ import√©es
 * V√©rifie: NEQ, codes postaux, adresses, villes, cat√©gories
 *
 * UTILISATION:
 * node scripts/validate-req-data.js
 *
 * OPTIONS:
 * --fix         Corriger automatiquement les erreurs simples
 * --limit=100   Limiter √† 100 entreprises
 */

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

const supabase = createClient(supabaseUrl, supabaseKey);

// Arguments
const args = process.argv.slice(2);
const limitArg = args.find(arg => arg.startsWith('--limit='));
const limit = limitArg ? parseInt(limitArg.split('=')[1]) : 10000;
const autoFix = args.includes('--fix');

console.log('üîç Validation des donn√©es REQ');
console.log('üìä Configuration:', { limit, autoFix });
console.log('');

// Statistiques
const stats = {
  total: 0,
  validNEQ: 0,
  invalidNEQ: 0,
  validPostalCode: 0,
  invalidPostalCode: 0,
  missingPostalCode: 0,
  hasAddress: 0,
  missingAddress: 0,
  hasCity: 0,
  missingCity: 0,
  cityMapped: 0,
  cityNotMapped: 0,
  hasSCIAN: 0,
  missingSCIAN: 0,
  hasCat: 0,
  missingCategory: 0,
  issues: []
};

/**
 * Valider format NEQ (10 chiffres)
 */
function validateNEQ(neq) {
  if (!neq) return { valid: false, error: 'NEQ manquant' };

  const cleaned = neq.replace(/\D/g, '');
  if (cleaned.length !== 10) {
    return { valid: false, error: `NEQ invalide (${cleaned.length} chiffres au lieu de 10)` };
  }

  return { valid: true };
}

/**
 * Valider code postal qu√©b√©cois (format: A1A 1A1 ou A1A1A1)
 */
function validatePostalCode(postalCode) {
  if (!postalCode) return { valid: false, error: 'Code postal manquant' };

  // Format canadien: lettre-chiffre-lettre chiffre-lettre-chiffre
  const cleaned = postalCode.replace(/\s/g, '').toUpperCase();
  const regex = /^[A-Z]\d[A-Z]\d[A-Z]\d$/;

  if (!regex.test(cleaned)) {
    return { valid: false, error: 'Format invalide', suggestion: null };
  }

  // V√©rifier premi√®re lettre (doit √™tre dans la plage du Qu√©bec: G, H, J)
  const firstLetter = cleaned[0];
  if (!['G', 'H', 'J'].includes(firstLetter)) {
    return { valid: false, error: 'Pas un code postal qu√©b√©cois', suggestion: null };
  }

  return { valid: true, normalized: `${cleaned.slice(0, 3)} ${cleaned.slice(3)}` };
}

/**
 * Valider la ville
 */
async function validateCity(city, mrc, region) {
  if (!city) return { valid: false, error: 'Ville manquante' };

  // V√©rifier si la ville est mapp√©e √† une r√©gion/MRC
  const isMapped = mrc && region;

  return { valid: true, mapped: isMapped };
}

/**
 * Valider l'entreprise compl√®te
 */
async function validateBusiness(business) {
  const issues = [];

  // NEQ
  const neqCheck = validateNEQ(business.neq);
  if (!neqCheck.valid) {
    issues.push({ type: 'NEQ', severity: 'HIGH', message: neqCheck.error });
    stats.invalidNEQ++;
  } else {
    stats.validNEQ++;
  }

  // Code postal
  if (!business.postal_code) {
    stats.missingPostalCode++;
    issues.push({ type: 'POSTAL_CODE', severity: 'MEDIUM', message: 'Code postal manquant' });
  } else {
    const postalCheck = validatePostalCode(business.postal_code);
    if (!postalCheck.valid) {
      stats.invalidPostalCode++;
      issues.push({ type: 'POSTAL_CODE', severity: 'MEDIUM', message: postalCheck.error });
    } else {
      stats.validPostalCode++;
    }
  }

  // Adresse
  if (!business.address || business.address.trim().length < 5) {
    stats.missingAddress++;
    issues.push({ type: 'ADDRESS', severity: 'HIGH', message: 'Adresse manquante ou invalide' });
  } else {
    stats.hasAddress++;
  }

  // Ville
  if (!business.city) {
    stats.missingCity++;
    issues.push({ type: 'CITY', severity: 'HIGH', message: 'Ville manquante' });
  } else {
    stats.hasCity++;

    const cityCheck = await validateCity(business.city, business.mrc, business.region);
    if (cityCheck.mapped) {
      stats.cityMapped++;
    } else {
      stats.cityNotMapped++;
      issues.push({ type: 'CITY', severity: 'LOW', message: `Ville "${business.city}" non mapp√©e √† une r√©gion/MRC` });
    }
  }

  // Code SCIAN
  if (!business.scian_code) {
    stats.missingSCIAN++;
    issues.push({ type: 'SCIAN', severity: 'LOW', message: 'Code SCIAN manquant' });
  } else {
    stats.hasSCIAN++;
  }

  // Cat√©gorie
  const { data: category } = await supabase
    .from('business_categories')
    .select('id')
    .eq('business_id', business.id)
    .limit(1)
    .single();

  if (!category) {
    stats.missingCategory++;
    issues.push({ type: 'CATEGORY', severity: 'MEDIUM', message: 'Cat√©gorie non assign√©e' });
  } else {
    stats.hasCat++;
  }

  return { business, issues };
}

/**
 * Validation principale
 */
async function validateAll() {
  console.log('üì• R√©cup√©ration des entreprises REQ...\n');

  const { data: businesses, error } = await supabase
    .from('businesses')
    .select('id, name, neq, address, city, mrc, region, postal_code, province, scian_code')
    .eq('data_source', 'req')
    .limit(limit);

  if (error) {
    console.error('‚ùå Erreur:', error);
    return;
  }

  stats.total = businesses.length;
  console.log(`‚úÖ ${stats.total} entreprises √† valider\n`);

  // Valider chaque entreprise
  for (let i = 0; i < businesses.length; i++) {
    const result = await validateBusiness(businesses[i]);

    if (result.issues.length > 0) {
      stats.issues.push({
        business: result.business.name,
        city: result.business.city,
        neq: result.business.neq,
        issues: result.issues
      });

      // Afficher les 10 premiers probl√®mes
      if (stats.issues.length <= 10) {
        console.log(`‚ö†Ô∏è  ${result.business.name} (${result.business.city || 'Ville inconnue'})`);
        result.issues.forEach(issue => {
          const icon = issue.severity === 'HIGH' ? 'üî¥' : issue.severity === 'MEDIUM' ? 'üü°' : 'üîµ';
          console.log(`   ${icon} ${issue.type}: ${issue.message}`);
        });
        console.log('');
      }
    }

    // Log progression
    if ((i + 1) % 100 === 0) {
      console.log(`üìä Progression: ${i + 1}/${stats.total}`);
    }
  }

  // Rapport final
  console.log('');
  console.log('‚úÖ Validation termin√©e!');
  console.log('‚ïê'.repeat(60));
  console.log('üìä RAPPORT DE VALIDATION');
  console.log('‚ïê'.repeat(60));
  console.log(`\nüè¢ TOTAL: ${stats.total} entreprises`);

  console.log(`\nüìù NEQ:`);
  console.log(`   ‚úÖ Valides:    ${stats.validNEQ} (${Math.round(stats.validNEQ/stats.total*100)}%)`);
  console.log(`   ‚ùå Invalides:  ${stats.invalidNEQ} (${Math.round(stats.invalidNEQ/stats.total*100)}%)`);

  console.log(`\nüì¨ CODES POSTAUX:`);
  console.log(`   ‚úÖ Valides:    ${stats.validPostalCode} (${Math.round(stats.validPostalCode/stats.total*100)}%)`);
  console.log(`   ‚ùå Invalides:  ${stats.invalidPostalCode} (${Math.round(stats.invalidPostalCode/stats.total*100)}%)`);
  console.log(`   ‚ö†Ô∏è  Manquants:  ${stats.missingPostalCode} (${Math.round(stats.missingPostalCode/stats.total*100)}%)`);

  console.log(`\nüè† ADRESSES:`);
  console.log(`   ‚úÖ Pr√©sentes:  ${stats.hasAddress} (${Math.round(stats.hasAddress/stats.total*100)}%)`);
  console.log(`   ‚ùå Manquantes: ${stats.missingAddress} (${Math.round(stats.missingAddress/stats.total*100)}%)`);

  console.log(`\nüèôÔ∏è  VILLES:`);
  console.log(`   ‚úÖ Pr√©sentes:  ${stats.hasCity} (${Math.round(stats.hasCity/stats.total*100)}%)`);
  console.log(`   üó∫Ô∏è  Mapp√©es:    ${stats.cityMapped} (${Math.round(stats.cityMapped/stats.total*100)}%)`);
  console.log(`   ‚ö†Ô∏è  Non mapp√©es: ${stats.cityNotMapped} (${Math.round(stats.cityNotMapped/stats.total*100)}%)`);
  console.log(`   ‚ùå Manquantes: ${stats.missingCity} (${Math.round(stats.missingCity/stats.total*100)}%)`);

  console.log(`\nüè∑Ô∏è  CODES SCIAN:`);
  console.log(`   ‚úÖ Pr√©sents:   ${stats.hasSCIAN} (${Math.round(stats.hasSCIAN/stats.total*100)}%)`);
  console.log(`   ‚ùå Manquants:  ${stats.missingSCIAN} (${Math.round(stats.missingSCIAN/stats.total*100)}%)`);

  console.log(`\nüìÇ CAT√âGORIES:`);
  console.log(`   ‚úÖ Assign√©es:  ${stats.hasCat} (${Math.round(stats.hasCat/stats.total*100)}%)`);
  console.log(`   ‚ùå Manquantes: ${stats.missingCategory} (${Math.round(stats.missingCategory/stats.total*100)}%)`);

  console.log(`\n‚ö†Ô∏è  PROBL√àMES D√âTECT√âS: ${stats.issues.length} entreprises`);

  console.log('‚ïê'.repeat(60));

  if (stats.issues.length > 10) {
    console.log(`\nüí° ${stats.issues.length - 10} autres entreprises avec probl√®mes non affich√©es`);
  }

  // Score de qualit√©
  const qualityScore = Math.round(
    ((stats.validNEQ + stats.validPostalCode + stats.hasAddress + stats.cityMapped + stats.hasSCIAN + stats.hasCat) /
    (stats.total * 6)) * 100
  );

  console.log(`\nüéØ SCORE DE QUALIT√â: ${qualityScore}%`);

  if (qualityScore >= 80) {
    console.log('‚úÖ Excellent! Donn√©es de haute qualit√©.');
  } else if (qualityScore >= 60) {
    console.log('üü° Bon. Quelques am√©liorations possibles.');
  } else {
    console.log('üî¥ Attention. Donn√©es n√©cessitent des corrections.');
  }

  console.log('');
}

// Ex√©cuter
validateAll()
  .then(() => {
    console.log('üéâ Script termin√© avec succ√®s!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('üí• Erreur fatale:', error);
    process.exit(1);
  });
