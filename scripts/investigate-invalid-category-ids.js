import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

async function investigateInvalidCategoryIds() {
  console.log('üîç Investigation des main_category_id invalides...\n');
  console.log('='.repeat(80));

  // 1. Trouver l'UUID sp√©cifique mentionn√©
  const problematicUUID = 'ae570981-13b3-4d4b-9f5c-b6ce0e8db8f9';

  console.log(`\n1Ô∏è‚É£ Recherche de l'UUID probl√©matique: ${problematicUUID}\n`);

  // V√©rifier si cet UUID existe dans main_categories
  const { data: catExists, error: catError } = await supabase
    .from('main_categories')
    .select('*')
    .eq('id', problematicUUID)
    .single();

  if (catExists) {
    console.log('‚úÖ Cet UUID EXISTE dans main_categories:');
    console.log(`   - ID: ${catExists.id}`);
    console.log(`   - Slug: ${catExists.slug}`);
    console.log(`   - Label FR: ${catExists.label_fr}`);
    console.log(`   - Label EN: ${catExists.label_en}`);
  } else {
    console.log('‚ùå Cet UUID N\'EXISTE PAS dans main_categories');
    console.log(`   Erreur: ${catError?.message || 'Not found'}`);
  }

  // 2. Compter combien d'entreprises utilisent cet UUID
  const { count: bizCount, error: bizError } = await supabase
    .from('businesses')
    .select('*', { count: 'exact', head: true })
    .eq('main_category_id', problematicUUID);

  console.log(`\nüìä ${bizCount || 0} entreprises utilisent cet UUID comme main_category_id`);

  // 3. √âchantillon d'entreprises avec cet UUID
  if (bizCount > 0) {
    const { data: bizSample } = await supabase
      .from('businesses')
      .select('id, name, slug, city, main_category_id')
      .eq('main_category_id', problematicUUID)
      .limit(5);

    console.log('\nüìã √âchantillon d\'entreprises avec cet UUID:\n');
    bizSample?.forEach((biz, i) => {
      console.log(`${i + 1}. ${biz.name} (${biz.city || 'N/A'})`);
      console.log(`   - Slug: ${biz.slug}`);
      console.log(`   - URL attendue: /categorie/{category_slug}/${biz.city}/${biz.slug}`);
      console.log(`   - URL actuelle: /${problematicUUID}/${biz.city}/${biz.slug}`);
      console.log('');
    });
  }

  // 4. V√©rifier TOUS les main_category_id invalides
  console.log('\n2Ô∏è‚É£ Recherche de TOUS les main_category_id invalides...\n');

  // Get all unique main_category_id from businesses
  const { data: allCategoryIds } = await supabase
    .from('businesses')
    .select('main_category_id')
    .not('main_category_id', 'is', null);

  if (allCategoryIds) {
    const uniqueIds = [...new Set(allCategoryIds.map(b => b.main_category_id))];
    console.log(`üìä ${uniqueIds.length} main_category_id uniques trouv√©s dans businesses`);

    // Get all valid IDs from main_categories
    const { data: validCategories } = await supabase
      .from('main_categories')
      .select('id');

    const validIds = new Set(validCategories?.map(c => c.id) || []);
    console.log(`‚úÖ ${validIds.size} cat√©gories valides dans main_categories`);

    // Find invalid IDs
    const invalidIds = uniqueIds.filter(id => !validIds.has(id));

    if (invalidIds.length > 0) {
      console.log(`\n‚ö†Ô∏è  ${invalidIds.length} main_category_id INVALIDES trouv√©s:\n`);

      for (const invalidId of invalidIds) {
        const { count } = await supabase
          .from('businesses')
          .select('*', { count: 'exact', head: true })
          .eq('main_category_id', invalidId);

        console.log(`   - ${invalidId}: ${count} entreprises`);
      }

      // 5. V√©rifier si ces UUIDs existent dans business_categories (l'ancienne table)
      console.log('\n3Ô∏è‚É£ V√©rification dans l\'ancienne table business_categories...\n');

      for (const invalidId of invalidIds.slice(0, 5)) { // Check first 5
        const { data: oldCat } = await supabase
          .from('business_categories')
          .select('id, name_fr, name_en, slug, parent_id')
          .eq('id', invalidId)
          .single();

        if (oldCat) {
          console.log(`‚úÖ ${invalidId} trouv√© dans business_categories (ancienne table):`);
          console.log(`   - Nom FR: ${oldCat.name_fr}`);
          console.log(`   - Nom EN: ${oldCat.name_en}`);
          console.log(`   - Slug: ${oldCat.slug}`);
          console.log(`   - Parent ID: ${oldCat.parent_id || 'NULL'}`);
          console.log('');
        } else {
          console.log(`‚ùå ${invalidId} N'EXISTE NULLE PART (ni main_categories ni business_categories)`);
          console.log('');
        }
      }

    } else {
      console.log('‚úÖ Aucun main_category_id invalide trouv√©!');
    }
  }

  // 6. R√©sum√© et recommandations
  console.log('\n' + '='.repeat(80));
  console.log('üìù R√âSUM√â ET RECOMMANDATIONS');
  console.log('='.repeat(80));

  const { count: totalBiz } = await supabase
    .from('businesses')
    .select('*', { count: 'exact', head: true });

  const { count: withMainCat } = await supabase
    .from('businesses')
    .select('*', { count: 'exact', head: true })
    .not('main_category_id', 'is', null);

  console.log(`
üìä √âTAT ACTUEL:
   Total entreprises:           ${totalBiz?.toLocaleString()}
   Avec main_category_id:       ${withMainCat?.toLocaleString()}
   Sans main_category_id:       ${(totalBiz - withMainCat)?.toLocaleString()}
  `);

  console.log('üîß PROBL√àME D√âTECT√â:');
  console.log('   Certaines entreprises ont des main_category_id qui pointent vers');
  console.log('   l\'ancienne table business_categories au lieu de main_categories');
  console.log('   Cela casse les URLs: /{uuid}/city/slug au lieu de /category/city/slug\n');

  console.log('üí° SOLUTION PROPOS√âE:');
  console.log('   Option 1: SET main_category_id = NULL pour ces entreprises');
  console.log('             ‚Üí Elles n\'auront plus de cat√©gorie cass√©e');
  console.log('             ‚Üí Puis utiliser le mapping ACT_ECON pour les recat√©goriser\n');

  console.log('   Option 2: Mapper business_categories ‚Üí main_categories');
  console.log('             ‚Üí Trouver la correspondance entre les deux syst√®mes');
  console.log('             ‚Üí Mettre √† jour avec les bons IDs de main_categories\n');

  console.log('   Option 3: Supprimer compl√®tement main_category_id invalides');
  console.log('             ‚Üí Nettoyer la DB');
  console.log('             ‚Üí Reconstruire via ACT_ECON mapping (propre)\n');

  console.log('üèÜ RECOMMANDATION: Option 3');
  console.log('   1. SET main_category_id = NULL WHERE main_category_id NOT IN main_categories');
  console.log('   2. Cr√©er le mapping act_econ_to_main_category');
  console.log('   3. Assigner les main_category_id via ACT_ECON (propre et fiable)');

  console.log('\n' + '='.repeat(80));
}

investigateInvalidCategoryIds().catch(console.error);
