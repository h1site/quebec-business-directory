/**
 * R√©initialiser main_category_id √† NULL pour les entreprises mal cat√©goris√©es
 *
 * Probl√®me: 953 entreprises ont main_category_id assign√© mais categories=[]
 * Ces assignations sont incorrectes et causent des probl√®mes dans la recherche.
 *
 * Exemple: NEQ 8880410194 (Office d'habitation) appara√Æt dans "Technologie"
 * alors qu'elle n'a AUCUNE cat√©gorie r√©elle.
 *
 * Solution: R√©initialiser main_category_id √† NULL pour ces entreprises.
 */

import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '..', '.env') });

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Variables Supabase manquantes!');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

const FETCH_BATCH_SIZE = 1000;
const UPDATE_BATCH_SIZE = 100; // Supabase has a limit on .in() operator

console.log('üîß NETTOYAGE DES main_category_id INCORRECTS\n');
console.log('‚ïê'.repeat(80));

// 1. R√©cup√©rer toutes les entreprises avec main_category_id mais categories=[]
console.log('\nüìä R√©cup√©ration des entreprises mal cat√©goris√©es...\n');

let allBadBusinesses = [];
let page = 0;
let hasMore = true;

while (hasMore) {
  const { data: batch, error } = await supabase
    .from('businesses')
    .select('id, neq, name, main_category_id, categories, act_econ_code')
    .not('main_category_id', 'is', null)
    .range(page * FETCH_BATCH_SIZE, (page + 1) * FETCH_BATCH_SIZE - 1);

  if (error) {
    console.error('‚ùå Erreur lors de la r√©cup√©ration:', error);
    break;
  }

  if (!batch || batch.length === 0) {
    hasMore = false;
    break;
  }

  // Filtrer celles avec categories vide
  const badOnes = batch.filter(b => !b.categories || b.categories.length === 0);
  allBadBusinesses = allBadBusinesses.concat(badOnes);

  console.log(`   Page ${page + 1}: ${badOnes.length} entreprises mal cat√©goris√©es trouv√©es (sur ${batch.length})`);

  page++;

  // Limite de s√©curit√©
  if (page > 200) {
    console.log('‚ö†Ô∏è  Limite de pages atteinte (200 pages = 200k entreprises)');
    break;
  }
}

console.log(`\n‚úÖ Total trouv√©: ${allBadBusinesses.length} entreprises mal cat√©goris√©es\n`);

if (allBadBusinesses.length === 0) {
  console.log('‚úÖ Aucune entreprise √† nettoyer!');
  process.exit(0);
}

// 2. Afficher un √©chantillon
console.log('üìã √âCHANTILLON (10 premiers):\n');
allBadBusinesses.slice(0, 10).forEach((biz, i) => {
  console.log(`${i + 1}. NEQ ${biz.neq}: ${biz.name}`);
  console.log(`   act_econ_code: ${biz.act_econ_code || 'NULL'}`);
  console.log(`   main_category_id: ${biz.main_category_id}`);
  console.log(`   categories: []`);
  console.log('');
});

console.log('‚ïê'.repeat(80));
console.log(`\n‚ö†Ô∏è  ATTENTION: Vous allez r√©initialiser main_category_id √† NULL pour ${allBadBusinesses.length} entreprises`);
console.log('   Cela inclut le NEQ 8880410194 (Office d\'habitation)\n');

// 3. Ex√©cuter le nettoyage par batch
console.log('üöÄ D√©but du nettoyage...\n');

let updated = 0;
let errors = 0;

for (let i = 0; i < allBadBusinesses.length; i += UPDATE_BATCH_SIZE) {
  const batch = allBadBusinesses.slice(i, i + UPDATE_BATCH_SIZE);
  const ids = batch.map(b => b.id);

  const { error } = await supabase
    .from('businesses')
    .update({ main_category_id: null })
    .in('id', ids);

  if (error) {
    console.error(`‚ùå Erreur batch ${Math.floor(i / UPDATE_BATCH_SIZE) + 1}:`, error);
    errors++;
  } else {
    updated += batch.length;
    const progress = ((i + batch.length) / allBadBusinesses.length * 100).toFixed(1);
    console.log(`   ‚úì Batch ${Math.floor(i / UPDATE_BATCH_SIZE) + 1}: ${batch.length} entreprises nettoy√©es (${progress}%)`);
  }
}

console.log('\n' + '‚ïê'.repeat(80));
console.log('\n‚úÖ NETTOYAGE TERMIN√â\n');
console.log(`   Entreprises nettoy√©es: ${updated}`);
console.log(`   Erreurs: ${errors}`);
console.log('\nüí° Ces entreprises n\'appara√Ætront plus dans les r√©sultats de recherche par cat√©gorie');
console.log('   car elles n\'ont PAS de vraie cat√©gorisation (categories=[])');
