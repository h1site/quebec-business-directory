/**
 * Script pour assigner automatiquement les cat√©gories aux entreprises
 * bas√©es sur leur code SCIAN
 *
 * UTILISATION:
 * node scripts/assign-categories-from-scian.js
 *
 * OPTIONS:
 * --limit=1000    Limiter √† 1000 entreprises
 * --dry-run       Afficher les assignations sans les cr√©er
 */

import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Variables d\'environnement Supabase manquantes!');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Arguments en ligne de commande
const args = process.argv.slice(2);
const limitArg = args.find(arg => arg.startsWith('--limit='));
const limit = limitArg ? parseInt(limitArg.split('=')[1]) : 10000;
const dryRun = args.includes('--dry-run');

console.log('üè∑Ô∏è  Assignment automatique des cat√©gories bas√©es sur SCIAN');
console.log('üìä Configuration:', { limit, dryRun });
console.log('');

/**
 * Trouver la cat√©gorie bas√©e sur le code SCIAN
 */
async function findCategoryByScian(scianCode) {
  if (!scianCode) {
    return { main_category_id: null, sub_category_id: null, confidence: 0, scian_matched: null };
  }

  // Nettoyer le code SCIAN (retirer espaces, tirets, etc.)
  const cleanCode = scianCode.toString().replace(/[^0-9]/g, '');

  // Chercher mapping exact en commen√ßant par le code le plus pr√©cis
  for (let digits = cleanCode.length; digits >= 2; digits--) {
    const code = cleanCode.substring(0, digits);

    const { data, error } = await supabase
      .from('scian_category_mapping')
      .select('scian_code, description_fr, main_category_id, sub_category_id, confidence_level')
      .eq('scian_code', code)
      .order('confidence_level', { ascending: false })
      .limit(1)
      .single();

    if (data && !error) {
      return {
        main_category_id: data.main_category_id,
        sub_category_id: data.sub_category_id,
        confidence: data.confidence_level,
        scian_matched: code,
        description_fr: data.description_fr
      };
    }
  }

  return { main_category_id: null, sub_category_id: null, confidence: 0, scian_matched: null };
}

/**
 * Assigner les cat√©gories
 */
async function assignCategories() {
  console.log('üîç Recherche des entreprises sans cat√©gorie avec code SCIAN...');

  // Trouver toutes les entreprises avec SCIAN mais sans cat√©gorie assign√©e
  const { data: businesses, error } = await supabase
    .from('businesses')
    .select('id, name, scian_code, city')
    .eq('data_source', 'req')
    .not('scian_code', 'is', null)
    .limit(limit);

  if (error) {
    console.error('‚ùå Erreur lors de la r√©cup√©ration des entreprises:', error);
    return;
  }

  console.log(`‚úÖ Trouv√© ${businesses.length} entreprises avec code SCIAN`);
  console.log('');

  let assigned = 0;
  let notFound = 0;
  let alreadyAssigned = 0;
  const batchSize = 50;
  let batch = [];

  for (let i = 0; i < businesses.length; i++) {
    const biz = businesses[i];

    // V√©rifier si d√©j√† une cat√©gorie assign√©e
    const { data: existing } = await supabase
      .from('business_categories')
      .select('id')
      .eq('business_id', biz.id)
      .limit(1)
      .single();

    if (existing) {
      alreadyAssigned++;
      continue;
    }

    // Trouver cat√©gorie via SCIAN
    const category = await findCategoryByScian(biz.scian_code);

    // Si on a une main_category_id, trouver une sous-cat√©gorie par d√©faut
    if (category.main_category_id && !category.sub_category_id) {
      const { data: defaultSub } = await supabase
        .from('sub_categories')
        .select('id')
        .eq('main_category_id', category.main_category_id)
        .limit(1)
        .single();

      if (defaultSub) {
        category.sub_category_id = defaultSub.id;
      }
    }

    if (category.sub_category_id) {
      if (dryRun) {
        console.log(`üîç [DRY-RUN] ${biz.name} (${biz.city})`);
        console.log(`   SCIAN: ${biz.scian_code} ‚Üí ${category.scian_matched} (${category.description_fr})`);
        console.log(`   Confidence: ${category.confidence}%`);
        console.log('');
      } else {
        batch.push({
          business_id: biz.id,
          sub_category_id: category.sub_category_id,
          is_primary: true
        });
      }

      assigned++;
    } else {
      notFound++;

      if (i < 10) { // Log premiers cas non trouv√©s
        console.log(`‚ö†Ô∏è  Pas de mapping pour SCIAN ${biz.scian_code}: ${biz.name}`);
      }
    }

    // Ins√©rer par batch
    if (batch.length >= batchSize) {
      const { error: insertError } = await supabase
        .from('business_categories')
        .insert(batch);

      if (insertError) {
        console.error('‚ùå Erreur insertion batch:', insertError.message);
      } else {
        console.log(`‚úÖ Assign√© ${assigned} cat√©gories (${Math.round(assigned/businesses.length*100)}%)`);
      }

      batch = [];
    }

    // Log progression
    if ((i + 1) % 500 === 0) {
      console.log(`üìä Progression: ${i + 1}/${businesses.length}`);
    }
  }

  // Ins√©rer dernier batch
  if (batch.length > 0 && !dryRun) {
    await supabase.from('business_categories').insert(batch);
  }

  console.log('');
  console.log('‚úÖ Assignment termin√©!');
  console.log('‚ïê'.repeat(50));
  console.log(`üìä Statistiques:`);
  console.log(`   Total trait√©:           ${businesses.length}`);
  console.log(`   Cat√©gories assign√©es:   ${assigned} (${Math.round(assigned/businesses.length*100)}%)`);
  console.log(`   D√©j√† assign√©es:         ${alreadyAssigned}`);
  console.log(`   SCIAN non mapp√©:        ${notFound} (${Math.round(notFound/businesses.length*100)}%)`);
  console.log('‚ïê'.repeat(50));
  console.log('');

  if (notFound > 0) {
    console.log('üí° Conseil: Ajoutez plus de mappings SCIAN dans migration_add_req_import_support.sql');
    console.log('   pour am√©liorer le taux de cat√©gorisation automatique.');
  }
}

// Ex√©cuter
assignCategories()
  .then(() => {
    console.log('üéâ Script termin√© avec succ√®s!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('üí• Erreur fatale:', error);
    process.exit(1);
  });
