import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

// Mapping de mots-cl√©s vers les category IDs
const KEYWORD_MAPPINGS = {
  // Construction et r√©novation (60beba89-442b-43ff-8fee-96a28922d789)
  '60beba89-442b-43ff-8fee-96a28922d789': [
    'construction', 'r√©novation', 'plomberie', 'plombier', '√©lectrique', '√©lectricien',
    'toiture', 'couvreur', 'peinture', 'peintre', 'menuiserie', 'menuisier',
    'ma√ßon', 'charpentier', 'entrepreneur g√©n√©ral', 'excavation', 'b√©ton',
    'r√©paration', 'rev√™tement', 'plancher', 'gypse', 'isolation'
  ],

  // Restauration et alimentation (ae570981-13b3-4d4b-9f5c-b6ce0e8db8f9)
  'ae570981-13b3-4d4b-9f5c-b6ce0e8db8f9': [
    'restaurant', 'caf√©', 'bar', 'bistro', 'brasserie', 'pizzeria', 'cantine',
    'traiteur', 'boulangerie', 'p√¢tisserie', 'boucherie', '√©picerie',
    'alimentation', 'buffet', 'grill', 'resto', 'food', 'cuisine'
  ],

  // Sant√© et bien-√™tre (b6f1a7d3-9a7c-4871-bd63-2770ba99540f)
  'b6f1a7d3-9a7c-4871-bd63-2770ba99540f': [
    'dentiste', 'm√©decin', 'clinique', 'pharmacie', 'physioth√©rapie', 'physio',
    'chiropratique', 'chiro', 'ost√©opathie', 'massoth√©rapie', 'massage',
    'optom√©triste', 'lunettes', 'sant√©', 'm√©dical', 'param√©dical', 'soins'
  ],

  // Automobile et transport (25933a72-f5d2-4eed-8275-397dc1a8c897)
  '25933a72-f5d2-4eed-8275-397dc1a8c897': [
    'garage', 'automobile', 'auto', 'm√©canique', 'm√©cano', 'carrosserie',
    'd√©bosselage', 'pneu', 'taxi', 'transport', 'camion', 'remorquage',
    'v√©hicule', 'concessionnaire', 'honda', 'toyota', 'ford', 'gm'
  ],

  // Immobilier (2a9a3e8f-e13b-4d4f-bb8c-b483a3c356ca)
  '2a9a3e8f-e13b-4d4f-bb8c-b483a3c356ca': [
    'immobilier', 'courtier immobilier', 'proprio direct', 'logement',
    'appartement', 'condo', 'maison', 'location', 'gestion immobili√®re'
  ],

  // Services professionnels (944753c0-0ebf-4d74-9168-268fab04fc0d)
  '944753c0-0ebf-4d74-9168-268fab04fc0d': [
    'avocat', 'notaire', 'comptable', 'cpa', 'consultant', 'conseiller',
    'expertise', 'juridique', 'fiscalit√©', 'ressources humaines', 'rh'
  ],

  // √âducation et formation (783970a1-2bed-4f8e-9f1b-29bfb68cf3b3)
  '783970a1-2bed-4f8e-9f1b-29bfb68cf3b3': [
    '√©cole', 'garderie', 'cpe', 'formation', 'cours', 'enseignement',
    '√©ducation', 'acad√©mie', 'coll√®ge', 'universit√©', 'tutorat'
  ],

  // Commerce de d√©tail (271eef26-7324-4a26-932e-9a52f60cc985)
  '271eef26-7324-4a26-932e-9a52f60cc985': [
    'boutique', 'magasin', 'commerce', 'vente', 'd√©tail', 'quincaillerie',
    'd√©panneur', 'pharmacie', 'fleuriste', 'bijouterie', 'v√™tement'
  ],

  // Agriculture et environnement (065589d2-5efd-47d5-a8b1-dcc418023bd6)
  '065589d2-5efd-47d5-a8b1-dcc418023bd6': [
    'ferme', 'agricole', 'agriculture', '√©levage', 'culture', 'serre',
    'mara√Æcher', 'paysagiste', 'am√©nagement paysager', 'jardin', 'horticulture'
  ],

  // Maison et services domestiques (ae549a95-5732-4b7f-8aa8-4460e087acbd)
  'ae549a95-5732-4b7f-8aa8-4460e087acbd': [
    'm√©nage', 'nettoyage', 'entretien m√©nager', 'femme de m√©nage',
    'aide domestique', 'conciergerie', 'lavage de vitres'
  ],

  // Technologie et informatique (efab1e6e-3c3b-4240-9625-c27477667630)
  'efab1e6e-3c3b-4240-9625-c27477667630': [
    'informatique', 'logiciel', 'web', 'programmation', 'd√©veloppement',
    'it', 'tech', 'num√©rique', 'digital', 'internet', 'site web'
  ],

  // Tourisme et h√©bergement (a43306cc-1d4f-4a49-bb28-41a372889b18)
  'a43306cc-1d4f-4a49-bb28-41a372889b18': [
    'h√¥tel', 'motel', 'auberge', 'g√Æte', 'h√©bergement', 'camping',
    'tourisme', 'vacances', 'chalet', 'location saisonni√®re'
  ],

  // Arts, m√©dias et divertissement (...)
  // Sports et loisirs (a57cc9f2-15f0-4ffe-880b-2d48f5fba09e)
  'a57cc9f2-15f0-4ffe-880b-2d48f5fba09e': [
    'gym', 'fitness', 'sport', 'golf', 'hockey', 'soccer', 'natation',
    'entra√Æneur', 'loisir', 'centre sportif', 'club'
  ]
};

const BATCH_SIZE = 1000;

async function categorizeByKeywords() {
  console.log('üè∑Ô∏è  Cat√©gorisation par mots-cl√©s dans les noms d\'entreprises\n');
  console.log('='.repeat(80));

  // Compter les entreprises sans cat√©gorie
  const { count: totalUncategorized } = await supabase
    .from('businesses')
    .select('*', { count: 'exact', head: true })
    .is('main_category_id', null);

  console.log(`\nüìä ${totalUncategorized.toLocaleString()} entreprises sans cat√©gorie`);
  console.log(`   Taille du batch: ${BATCH_SIZE}`);
  console.log(`   Batches estim√©s: ${Math.ceil(totalUncategorized / BATCH_SIZE)}\n`);

  let totalCategorized = 0;
  let processed = 0;
  const categoryStats = {};

  while (processed < totalUncategorized) {
    // Fetch batch
    const { data: businesses } = await supabase
      .from('businesses')
      .select('id, name, description')
      .is('main_category_id', null)
      .range(0, BATCH_SIZE - 1);

    if (!businesses || businesses.length === 0) {
      break;
    }

    const updates = [];

    for (const biz of businesses) {
      const searchText = `${biz.name} ${biz.description || ''}`.toLowerCase();
      let matchedCategory = null;
      let maxScore = 0;

      // Chercher la meilleure correspondance
      for (const [categoryId, keywords] of Object.entries(KEYWORD_MAPPINGS)) {
        let score = 0;
        for (const keyword of keywords) {
          if (searchText.includes(keyword.toLowerCase())) {
            score += keyword.length; // Mots plus longs = meilleur score
          }
        }

        if (score > maxScore) {
          maxScore = score;
          matchedCategory = categoryId;
        }
      }

      if (matchedCategory) {
        updates.push({ id: biz.id, categoryId: matchedCategory });
        categoryStats[matchedCategory] = (categoryStats[matchedCategory] || 0) + 1;
      }
    }

    // Mettre √† jour par groupes de cat√©gorie
    for (const [categoryId, count] of Object.entries(categoryStats)) {
      const ids = updates.filter(u => u.categoryId === categoryId).map(u => u.id);

      if (ids.length > 0) {
        const { error } = await supabase
          .from('businesses')
          .update({ main_category_id: categoryId })
          .in('id', ids);

        if (!error) {
          totalCategorized += ids.length;
        }
      }
    }

    processed += businesses.length;
    const progress = ((processed / totalUncategorized) * 100).toFixed(1);

    console.log(`üì¶ Batch termin√©`);
    console.log(`   Progr√®s: ${processed.toLocaleString()}/${totalUncategorized.toLocaleString()} (${progress}%)`);
    console.log(`   ‚úÖ Cat√©goris√©es dans ce batch: ${updates.length}`);
    console.log(`   üìä Total cat√©goris√©es: ${totalCategorized.toLocaleString()}\n`);

    // Pause pour ne pas surcharger l'API
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  console.log('\n' + '='.repeat(80));
  console.log('‚úÖ TERMIN√â!\n');
  console.log(`üìä R√©sultat final:`);
  console.log(`   Trait√©: ${processed.toLocaleString()} entreprises`);
  console.log(`   Cat√©goris√©es: ${totalCategorized.toLocaleString()} entreprises`);
  console.log(`   Taux de correspondance: ${((totalCategorized / processed) * 100).toFixed(1)}%\n`);

  console.log('üìà R√©partition par cat√©gorie:');
  Object.entries(categoryStats)
    .sort((a, b) => b[1] - a[1])
    .forEach(([catId, count]) => {
      console.log(`   ${catId}: ${count.toLocaleString()} entreprises`);
    });
}

categorizeByKeywords().catch(console.error);
