/**
 * Script d'enrichissement COMPLET des donn√©es REQ via Google Places API
 * R√©cup√®re: t√©l√©phone, site web, horaires, note Google, avis, LOGO et PHOTOS
 *
 * UTILISATION:
 * node scripts/enrich-req-with-photos.js
 *
 * OPTIONS:
 * --limit=100   Limiter √† 100 entreprises
 * --dry-run     Afficher les r√©sultats sans les sauvegarder
 * --batch=10    Traiter par lots de X entreprises (d√©faut: 10)
 *
 * PR√âREQUIS:
 * - VITE_GOOGLE_MAPS_API_KEY dans .env
 * - SUPABASE_SERVICE_KEY dans .env (pour upload photos)
 * - API Google Places activ√©e
 */

import { createClient } from '@supabase/supabase-js';
import fetch from 'node-fetch';
import crypto from 'crypto';

const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY;
const googleApiKey = process.env.VITE_GOOGLE_MAPS_API_KEY;

if (!googleApiKey) {
  console.error('‚ùå VITE_GOOGLE_MAPS_API_KEY manquant dans .env');
  process.exit(1);
}

if (!supabaseKey) {
  console.error('‚ùå Cl√© Supabase manquante dans .env');
  process.exit(1);
}

// Client Supabase
const supabase = createClient(supabaseUrl, supabaseKey);

// Arguments
const args = process.argv.slice(2);
const limitArg = args.find(arg => arg.startsWith('--limit='));
const batchArg = args.find(arg => arg.startsWith('--batch='));
const limit = limitArg ? parseInt(limitArg.split('=')[1]) : 2000;
const batchSize = batchArg ? parseInt(batchArg.split('=')[1]) : 10;
const dryRun = args.includes('--dry-run');

console.log('üåê Enrichissement COMPLET des donn√©es REQ via Google Places API');
console.log('üì∏ Inclut: t√©l√©phone, site web, notes, avis, LOGO et PHOTOS');
console.log('üìä Configuration:', { limit, batchSize, dryRun });
console.log('');

// Statistiques
const stats = {
  total: 0,
  enriched: 0,
  notFound: 0,
  errors: 0,
  phoneAdded: 0,
  websiteAdded: 0,
  ratingAdded: 0,
  logoAdded: 0,
  photosAdded: 0
};

/**
 * Rechercher une entreprise sur Google Places
 */
async function searchGooglePlaces(businessName, address, city) {
  const query = `${businessName}, ${address}, ${city}, Qu√©bec`;

  const url = `https://maps.googleapis.com/maps/api/place/findplacefromtext/json?input=${encodeURIComponent(query)}&inputtype=textquery&fields=place_id,name,formatted_address&key=${googleApiKey}`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.status === 'OK' && data.candidates && data.candidates.length > 0) {
      return data.candidates[0].place_id;
    }

    return null;
  } catch (error) {
    console.error('‚ùå Erreur recherche Google Places:', error.message);
    return null;
  }
}

/**
 * R√©cup√©rer les d√©tails d'un lieu Google Places
 */
async function getPlaceDetails(placeId) {
  const fields = [
    'name',
    'formatted_phone_number',
    'international_phone_number',
    'website',
    'rating',
    'user_ratings_total',
    'opening_hours',
    'geometry',
    'photos',
    'reviews',
    'icon',
    'types',
    'business_status',
    'formatted_address'
  ].join(',');

  const url = `https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=${fields}&key=${googleApiKey}&language=fr`;

  try {
    const response = await fetch(url);
    const data = await response.json();

    if (data.status === 'OK') {
      return data.result;
    }

    return null;
  } catch (error) {
    console.error('‚ùå Erreur d√©tails Google Places:', error.message);
    return null;
  }
}

/**
 * T√©l√©charger une photo depuis Google Places
 */
async function downloadGooglePhoto(photoReference, maxWidth = 1200) {
  const url = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=${maxWidth}&photo_reference=${photoReference}&key=${googleApiKey}`;

  try {
    const response = await fetch(url);

    if (!response.ok) {
      console.error(`   ‚ö†Ô∏è  Erreur t√©l√©chargement photo: ${response.status}`);
      return null;
    }

    const arrayBuffer = await response.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);

    return buffer;
  } catch (error) {
    console.error('   ‚ùå Erreur t√©l√©chargement photo:', error.message);
    return null;
  }
}

/**
 * Upload une image vers Supabase Storage
 */
async function uploadToSupabase(buffer, fileName, bucket = 'business-photos') {
  try {
    const { data, error } = await supabase.storage
      .from(bucket)
      .upload(fileName, buffer, {
        contentType: 'image/jpeg',
        cacheControl: '3600',
        upsert: true
      });

    if (error) {
      console.error(`   ‚ùå Erreur upload Supabase:`, error.message);
      return null;
    }

    // Get public URL
    const { data: urlData } = supabase.storage
      .from(bucket)
      .getPublicUrl(fileName);

    return urlData.publicUrl;
  } catch (error) {
    console.error('   ‚ùå Erreur upload:', error.message);
    return null;
  }
}

/**
 * G√©n√©rer un nom de fichier unique
 */
function generateFileName(businessId, type = 'photo', index = 0) {
  const hash = crypto.createHash('md5').update(businessId).digest('hex').substring(0, 8);
  const timestamp = Date.now();

  if (type === 'logo') {
    return `logos/${hash}-${timestamp}.jpg`;
  }

  return `photos/${hash}-${index}-${timestamp}.jpg`;
}

/**
 * Enrichir une entreprise avec photos
 */
async function enrichBusinessWithPhotos(business) {
  console.log(`üîç ${business.name} (${business.city})`);

  // Rechercher sur Google Places
  const placeId = await searchGooglePlaces(business.name, business.address, business.city);

  if (!placeId) {
    console.log('   ‚ö†Ô∏è  Non trouv√© sur Google Places');
    stats.notFound++;
    return null;
  }

  console.log(`   ‚úÖ Trouv√©: ${placeId}`);

  // R√©cup√©rer les d√©tails
  const details = await getPlaceDetails(placeId);

  if (!details) {
    console.log('   ‚ö†Ô∏è  Impossible de r√©cup√©rer les d√©tails');
    stats.errors++;
    return null;
  }

  // Pr√©parer les donn√©es d'enrichissement
  const enrichmentData = {};

  // T√©l√©phone
  if (details.formatted_phone_number || details.international_phone_number) {
    enrichmentData.phone = details.formatted_phone_number || details.international_phone_number;
    console.log(`   üìû T√©l√©phone: ${enrichmentData.phone}`);
    stats.phoneAdded++;
  }

  // Site web
  if (details.website) {
    enrichmentData.website = details.website;
    console.log(`   üåê Site web: ${enrichmentData.website}`);
    stats.websiteAdded++;
  }

  // Note Google
  if (details.rating) {
    enrichmentData.google_rating = details.rating;
    enrichmentData.google_reviews_count = details.user_ratings_total || 0;
    console.log(`   ‚≠ê Note: ${details.rating}/5 (${details.user_ratings_total} avis)`);
    stats.ratingAdded++;
  }

  // Coordonn√©es
  if (details.geometry && details.geometry.location) {
    enrichmentData.latitude = details.geometry.location.lat;
    enrichmentData.longitude = details.geometry.location.lng;
    console.log(`   üìç Coordonn√©es: ${enrichmentData.latitude}, ${enrichmentData.longitude}`);
  }

  // Types/Cat√©gories Google
  if (details.types && Array.isArray(details.types)) {
    enrichmentData.google_types = details.types;
    console.log(`   üè∑Ô∏è  Types: ${details.types.slice(0, 3).join(', ')}`);
  }

  // LOGO (icon)
  if (details.icon) {
    console.log(`   üé® T√©l√©chargement du logo...`);
    try {
      // Download icon
      const iconResponse = await fetch(details.icon);
      if (iconResponse.ok) {
        const iconBuffer = Buffer.from(await iconResponse.arrayBuffer());
        const logoFileName = generateFileName(business.id, 'logo');
        const logoUrl = await uploadToSupabase(iconBuffer, logoFileName, 'business-logos');

        if (logoUrl) {
          enrichmentData.logo_url = logoUrl;
          console.log(`   ‚úÖ Logo upload√©: ${logoUrl}`);
          stats.logoAdded++;
        }
      }
    } catch (error) {
      console.log(`   ‚ö†Ô∏è  Erreur logo: ${error.message}`);
    }
  }

  // PHOTOS
  if (details.photos && Array.isArray(details.photos) && details.photos.length > 0) {
    console.log(`   üì∏ ${details.photos.length} photos disponibles, t√©l√©chargement de 5 max...`);
    const galleryUrls = [];
    const maxPhotos = Math.min(5, details.photos.length);

    for (let i = 0; i < maxPhotos; i++) {
      const photo = details.photos[i];

      if (photo.photo_reference) {
        const photoBuffer = await downloadGooglePhoto(photo.photo_reference);

        if (photoBuffer) {
          const photoFileName = generateFileName(business.id, 'photo', i);
          const photoUrl = await uploadToSupabase(photoBuffer, photoFileName, 'business-photos');

          if (photoUrl) {
            galleryUrls.push(photoUrl);
            console.log(`   ‚úÖ Photo ${i + 1}/${maxPhotos} upload√©e`);
          }
        }

        // Pause pour √©viter de surcharger l'API
        await new Promise(resolve => setTimeout(resolve, 200));
      }
    }

    if (galleryUrls.length > 0) {
      enrichmentData.gallery_images = galleryUrls;
      stats.photosAdded += galleryUrls.length;
      console.log(`   üì∏ ${galleryUrls.length} photos upload√©es`);
    }
  }

  console.log('');
  stats.enriched++;

  return enrichmentData;
}

/**
 * Sauvegarder les donn√©es enrichies
 */
async function saveEnrichment(businessId, enrichmentData) {
  if (dryRun) {
    console.log(`   [DRY-RUN] Sauvegarderait:`, Object.keys(enrichmentData));
    return true;
  }

  const { error } = await supabase
    .from('businesses')
    .update(enrichmentData)
    .eq('id', businessId);

  if (error) {
    console.error(`   ‚ùå Erreur sauvegarde:`, error.message);
    return false;
  }

  return true;
}

/**
 * Enrichissement principal
 */
async function enrichAll() {
  console.log('üì• R√©cup√©ration des entreprises REQ √† enrichir...\n');

  // R√©cup√©rer entreprises sans logo
  const { data: businesses, error } = await supabase
    .from('businesses')
    .select('id, name, address, city, postal_code')
    .eq('data_source', 'req')
    .is('logo_url', null) // Seulement celles sans logo
    .limit(limit);

  if (error) {
    console.error('‚ùå Erreur:', error);
    return;
  }

  stats.total = businesses.length;
  console.log(`‚úÖ ${stats.total} entreprises √† enrichir\n`);

  for (let i = 0; i < businesses.length; i++) {
    const biz = businesses[i];

    try {
      const enrichmentData = await enrichBusinessWithPhotos(biz);

      if (enrichmentData) {
        await saveEnrichment(biz.id, enrichmentData);
      }

      // Pause pour respecter les limites API (max 50 req/s)
      await new Promise(resolve => setTimeout(resolve, 500));

    } catch (error) {
      console.error(`‚ùå Erreur pour ${biz.name}:`, error.message);
      stats.errors++;
    }

    // Log progression
    if ((i + 1) % batchSize === 0 || i === businesses.length - 1) {
      console.log(`\nüìä Progression: ${i + 1}/${stats.total}`);
      console.log(`   ‚úÖ Enrichies: ${stats.enriched} | ‚ö†Ô∏è  Non trouv√©es: ${stats.notFound} | ‚ùå Erreurs: ${stats.errors}`);
      console.log(`   üì∏ Logos: ${stats.logoAdded} | Photos: ${stats.photosAdded}`);
      console.log('');
    }
  }

  // Rapport final
  console.log('');
  console.log('‚úÖ Enrichissement termin√©!');
  console.log('‚ïê'.repeat(60));
  console.log('üìä RAPPORT D\'ENRICHISSEMENT');
  console.log('‚ïê'.repeat(60));
  console.log(`\nüè¢ TOTAL: ${stats.total} entreprises`);
  console.log(`   ‚úÖ Enrichies:     ${stats.enriched} (${Math.round(stats.enriched/stats.total*100)}%)`);
  console.log(`   ‚ö†Ô∏è  Non trouv√©es:  ${stats.notFound} (${Math.round(stats.notFound/stats.total*100)}%)`);
  console.log(`   ‚ùå Erreurs:       ${stats.errors} (${Math.round(stats.errors/stats.total*100)}%)`);

  console.log(`\nüìä DONN√âES AJOUT√âES:`);
  console.log(`   üìû T√©l√©phones:    ${stats.phoneAdded}`);
  console.log(`   üåê Sites web:     ${stats.websiteAdded}`);
  console.log(`   ‚≠ê Notes Google:  ${stats.ratingAdded}`);
  console.log(`   üé® Logos:         ${stats.logoAdded}`);
  console.log(`   üì∏ Photos:        ${stats.photosAdded}`);

  console.log('‚ïê'.repeat(60));

  // Estimation co√ªt API
  const searchCalls = stats.enriched;
  const detailsCalls = stats.enriched;
  const photoCalls = stats.photosAdded + stats.logoAdded;
  const totalCalls = searchCalls + detailsCalls + photoCalls;

  console.log(`\nüí∞ Utilisation API Google Places:`);
  console.log(`   Recherches:    ${searchCalls}`);
  console.log(`   D√©tails:       ${detailsCalls}`);
  console.log(`   Photos:        ${photoCalls}`);
  console.log(`   Total appels:  ${totalCalls}`);

  if (totalCalls <= 28000) {
    console.log(`   ‚úÖ GRATUIT (sous les 28,000 appels gratuits/mois)`);
  } else {
    const cost = ((totalCalls - 28000) / 1000) * 17;
    console.log(`   ‚ö†Ô∏è  Co√ªt estim√©: ~$${cost.toFixed(2)} USD`);
  }

  console.log('');
}

// Ex√©cuter
enrichAll()
  .then(() => {
    console.log('üéâ Script termin√© avec succ√®s!');
    process.exit(0);
  })
  .catch((error) => {
    console.error('üí• Erreur fatale:', error);
    process.exit(1);
  });
