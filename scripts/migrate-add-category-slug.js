/**
 * Migration: Ajouter main_category_slug √† la table businesses
 */

import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

dotenv.config({ path: path.join(__dirname, '..', '.env') });

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.VITE_SUPABASE_SERVICE_ROLE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
  console.error('‚ùå Variables Supabase manquantes!');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

console.log('üîß MIGRATION: Ajouter main_category_slug √† businesses');
console.log('‚ïê'.repeat(60));

async function runMigration() {
  try {
    // 1. Ajouter la colonne (si elle n'existe pas d√©j√†)
    console.log('1Ô∏è‚É£  V√©rification de la colonne main_category_slug...');

    // Note: Supabase ne permet pas d'ex√©cuter ALTER TABLE directement via l'API
    // Il faut utiliser le SQL Editor ou une fonction RPC
    // Pour l'instant, on va juste mettre √† jour les donn√©es

    // 2. Mettre √† jour tous les businesses avec leur main_category_slug
    console.log('2Ô∏è‚É£  Mise √† jour des main_category_slug...');

    const BATCH_SIZE = 500;
    let offset = 0;
    let totalUpdated = 0;
    let totalSkipped = 0;

    while (true) {
      // R√©cup√©rer un lot de businesses
      const { data: businesses, error: fetchError } = await supabase
        .from('businesses')
        .select(`
          id,
          main_category_slug,
          business_categories!inner (
            is_primary,
            sub_categories!inner (
              main_categories!inner (
                slug
              )
            )
          )
        `)
        .eq('business_categories.is_primary', true)
        .range(offset, offset + BATCH_SIZE - 1);

      if (fetchError) {
        console.error(`   ‚ùå Erreur de r√©cup√©ration: ${fetchError.message}`);
        break;
      }

      if (!businesses || businesses.length === 0) {
        break;
      }

      // Mettre √† jour chaque business
      for (const biz of businesses) {
        const categorySlug = biz.business_categories?.[0]?.sub_categories?.main_categories?.slug;

        if (!categorySlug) {
          console.log(`   ‚ö†Ô∏è  Business ${biz.id}: pas de cat√©gorie trouv√©e`);
          totalSkipped++;
          continue;
        }

        // Skip si d√©j√† √† jour
        if (biz.main_category_slug === categorySlug) {
          totalSkipped++;
          continue;
        }

        // Mettre √† jour
        const { error: updateError } = await supabase
          .from('businesses')
          .update({ main_category_slug: categorySlug })
          .eq('id', biz.id);

        if (updateError) {
          console.error(`   ‚ùå Erreur de mise √† jour pour ${biz.id}: ${updateError.message}`);
        } else {
          totalUpdated++;
        }
      }

      console.log(`   ‚úÖ Trait√© ${offset + businesses.length} businesses (${totalUpdated} mis √† jour, ${totalSkipped} ignor√©s)`);

      if (businesses.length < BATCH_SIZE) {
        break;
      }

      offset += BATCH_SIZE;
    }

    console.log('');
    console.log('‚úÖ MIGRATION TERMIN√âE!');
    console.log('‚ïê'.repeat(60));
    console.log(`üìä Businesses mis √† jour: ${totalUpdated}`);
    console.log(`‚è≠Ô∏è  Businesses ignor√©s: ${totalSkipped}`);
    console.log('‚ïê'.repeat(60));

  } catch (error) {
    console.error('‚ùå Erreur durant la migration:', error);
    process.exit(1);
  }
}

runMigration();
