import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.VITE_SUPABASE_ANON_KEY
);

console.log('üè∑Ô∏è  POPULATION DES CAT√âGORIES DEPUIS ACT_ECON MAPPINGS\n');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

async function populateCategories() {
  // 1. Get all mappings with confidence >= 0.5
  console.log('üìä Chargement des mappings ACT_ECON...\n');

  const { data: mappings, error: mappingsError } = await supabase
    .from('act_econ_category_mappings')
    .select('act_econ_code, main_category_id, sub_category_id, confidence_score')
    .gte('confidence_score', 0.5);

  if (mappingsError) {
    console.error('‚ùå Erreur lors du chargement des mappings:', mappingsError);
    return;
  }

  console.log(`‚úÖ ${mappings.length} mappings charg√©s\n`);

  // 2. For each mapping, update businesses with that ACT_ECON code
  let updated = 0;
  let errors = 0;
  const BATCH_SIZE = 100;

  console.log('üöÄ D√©but de la mise √† jour des cat√©gories...\n');

  for (let i = 0; i < mappings.length; i += BATCH_SIZE) {
    const batch = mappings.slice(i, i + BATCH_SIZE);

    // Process batch in parallel
    await Promise.all(
      batch.map(async (mapping) => {
        try {
          // Build categories array
          const categoriesArray = [mapping.main_category_id];
          if (mapping.sub_category_id) {
            categoriesArray.push(mapping.sub_category_id);
          }

          // Update all businesses with this ACT_ECON code
          const { error: updateError, count } = await supabase
            .from('businesses')
            .update({
              categories: categoriesArray
            })
            .eq('act_econ_code', mapping.act_econ_code)
            // Only update if categories is empty array
            .or('categories.is.null,categories.eq.[]');

          if (updateError) {
            console.error(`  ‚ùå Erreur pour code ${mapping.act_econ_code}:`, updateError.message);
            errors++;
          } else {
            updated++;
            if (updated % 50 === 0) {
              console.log(`  ‚è≥ ${updated}/${mappings.length} codes trait√©s...`);
            }
          }
        } catch (err) {
          console.error(`  ‚ùå Exception pour code ${mapping.act_econ_code}:`, err.message);
          errors++;
        }
      })
    );
  }

  console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log(`‚úÖ Traitement termin√©!`);
  console.log(`   Codes trait√©s: ${updated}`);
  console.log(`   Erreurs: ${errors}`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

  // 3. Verify results
  console.log('üîç V√©rification des r√©sultats...\n');

  const { count: totalBiz } = await supabase
    .from('businesses')
    .select('*', { count: 'exact', head: true });

  const { count: withActEcon } = await supabase
    .from('businesses')
    .select('*', { count: 'exact', head: true })
    .not('act_econ_code', 'is', null);

  // Count businesses with non-empty categories array
  const { data: withCats } = await supabase
    .from('businesses')
    .select('categories')
    .not('categories', 'is', null);

  const nonEmptyCats = withCats?.filter(b => b.categories && b.categories.length > 0).length || 0;

  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log(`Total businesses: ${totalBiz?.toLocaleString() || 0}`);
  console.log(`Avec ACT_ECON: ${withActEcon?.toLocaleString() || 0}`);
  console.log(`Avec cat√©gories assign√©es: ${nonEmptyCats.toLocaleString()}`);
  console.log(`Taux d'assignment: ${((nonEmptyCats / (withActEcon || 1)) * 100).toFixed(1)}%`);
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');

  // Show sample
  const { data: sample } = await supabase
    .from('businesses')
    .select('name, act_econ_code, categories')
    .not('act_econ_code', 'is', null)
    .limit(5);

  console.log('üìã Exemples:\n');
  sample?.forEach(b => {
    console.log(`  ‚úì ${b.name}`);
    console.log(`    ACT_ECON: ${b.act_econ_code}`);
    console.log(`    Categories: ${JSON.stringify(b.categories)}`);
  });
}

populateCategories();
