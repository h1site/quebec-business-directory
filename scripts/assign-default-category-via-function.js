#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

// Cat√©gorie par d√©faut: "Services professionnels"
const DEFAULT_CATEGORY_ID = '944753c0-0ebf-4d74-9168-268fab04fc0d';
const BATCH_SIZE = 5000;

async function assignDefaultCategoryViaFunction() {
  console.log('üöÄ Assignment de la cat√©gorie par d√©faut via fonction SQL...\n');
  console.log(`üì¶ Taille des batches: ${BATCH_SIZE.toLocaleString()}\n`);

  try {
    let totalUpdated = 0;
    let batchNumber = 0;

    while (true) {
      batchNumber++;
      console.log(`\nüì¶ Batch ${batchNumber}...`);

      // Appeler la fonction SQL qui met √† jour un batch
      const { data, error } = await supabase.rpc('update_categories_batch', {
        category_id: DEFAULT_CATEGORY_ID,
        batch_size: BATCH_SIZE
      });

      if (error) {
        console.error('‚ùå Erreur:', error);
        console.log('\n‚ö†Ô∏è  Assurez-vous que la fonction SQL a √©t√© cr√©√©e dans Supabase!');
        console.log('   Ex√©cutez: supabase/update_categories_batch_function.sql');
        break;
      }

      const updated = data || 0;
      totalUpdated += updated;

      console.log(`   ‚úÖ ${updated.toLocaleString()} businesses mises √† jour`);
      console.log(`   üìä Total cumulatif: ${totalUpdated.toLocaleString()}`);

      // Si moins que le batch size, on a fini
      if (updated < BATCH_SIZE) {
        console.log('\n‚úÖ Plus de businesses sans cat√©gories!');
        break;
      }

      // Petite pause entre les batches
      await new Promise(resolve => setTimeout(resolve, 200));
    }

    console.log('\n\nüéâ TERMIN√â!');
    console.log(`üìä Total businesses mises √† jour: ${totalUpdated.toLocaleString()}`);
    console.log(`üìä Batches trait√©s: ${batchNumber}`);

    // V√©rification finale
    console.log('\nüîç V√©rification finale...');

    const { count: totalBusinesses } = await supabase
      .from('businesses')
      .select('id', { count: 'exact', head: true });

    const { count: withoutCategories } = await supabase
      .from('businesses')
      .select('id', { count: 'exact', head: true })
      .or('categories.is.null,categories.eq.{}');

    const withCategories = totalBusinesses - withoutCategories;

    console.log(`\nüéØ R√©sum√© final:`);
    console.log(`   Total businesses: ${totalBusinesses?.toLocaleString()}`);
    console.log(`   Avec cat√©gories: ${withCategories?.toLocaleString()}`);
    console.log(`   Sans cat√©gories: ${withoutCategories?.toLocaleString()}`);
    console.log(`   Pourcentage: ${((withCategories / totalBusinesses) * 100).toFixed(1)}%`);

  } catch (error) {
    console.error('‚ùå Erreur fatale:', error);
  }
}

assignDefaultCategoryViaFunction();
