#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabase = createClient(
  process.env.VITE_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_KEY
);

// Mapping de mots-cl√©s vers cat√©gories (UUID des cat√©gories principales)
const CATEGORY_KEYWORDS = {
  // Restaurants & Alimentation
  'restaurant': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'caf√©': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'bar': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'boulangerie': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'p√¢tisserie': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'traiteur': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'pizzeria': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'brasserie': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',
  'bistro': '7c1c6c89-ec29-4cf1-95de-ae601f0a4bc9',

  // Construction & R√©novation
  'construction': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'entrepreneur': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'plombier': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  '√©lectricien': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'menuisier': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'peintre': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'couvreur': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'excavation': '2a2184fd-03c6-4d3a-ab75-bf250e980531',
  'r√©novation': '2a2184fd-03c6-4d3a-ab75-bf250e980531',

  // Sant√© & Bien-√™tre
  'dentiste': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',
  'm√©decin': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',
  'clinique': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',
  'pharmacie': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',
  'physioth√©rapie': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',
  'chiropraticien': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',
  'massoth√©rapie': 'a4787067-aa61-4b89-a9cc-c1b5d61804b5',

  // Services professionnels
  'avocat': 'eb652026-64e2-44b9-add1-02fd2df8da2b',
  'notaire': 'eb652026-64e2-44b9-add1-02fd2df8da2b',
  'comptable': 'eb652026-64e2-44b9-add1-02fd2df8da2b',
  'comptabilit√©': 'eb652026-64e2-44b9-add1-02fd2df8da2b',
  'consultant': 'eb652026-64e2-44b9-add1-02fd2df8da2b',

  // Commerce de d√©tail
  'boutique': '5a3c70f8-c70a-4a09-8b8f-eadc06d24c0f',
  'magasin': '5a3c70f8-c70a-4a09-8b8f-eadc06d24c0f',
  'commerce': '5a3c70f8-c70a-4a09-8b8f-eadc06d24c0f',
  'v√™tement': '5a3c70f8-c70a-4a09-8b8f-eadc06d24c0f',

  // Automobile
  'garage': '60beba89-442b-43ff-8fee-96a28922d789',
  'm√©canique': '60beba89-442b-43ff-8fee-96a28922d789',
  'carrosserie': '60beba89-442b-43ff-8fee-96a28922d789',
  'auto': '60beba89-442b-43ff-8fee-96a28922d789',

  // Beaut√© & Soins personnels
  'coiffure': 'cde982ec-5b91-4e84-bf63-d5ea3b9c0f8d',
  'salon': 'cde982ec-5b91-4e84-bf63-d5ea3b9c0f8d',
  'esth√©tique': 'cde982ec-5b91-4e84-bf63-d5ea3b9c0f8d',
  'spa': 'cde982ec-5b91-4e84-bf63-d5ea3b9c0f8d',

  // Immobilier
  'immobilier': '52bfec66-2f72-4b8b-9ab5-6ab99f5b6c4e',
  'courtier immobilier': '52bfec66-2f72-4b8b-9ab5-6ab99f5b6c4e',

  // Agriculture
  'ferme': '065589d2-5efd-47d5-a8b1-dcc418023bd6',
  'agricole': '065589d2-5efd-47d5-a8b1-dcc418023bd6',
  '√©levage': '065589d2-5efd-47d5-a8b1-dcc418023bd6'
};

async function assignCategoriesByName() {
  console.log('üöÄ Assignment des cat√©gories bas√© sur le nom de l\'entreprise...\n');

  try {
    let totalUpdated = 0;
    let processedKeywords = 0;

    // Pour chaque mot-cl√©
    for (const [keyword, categoryId] of Object.entries(CATEGORY_KEYWORDS)) {
      console.log(`üîç Recherche: "${keyword}"...`);

      // Mettre √† jour toutes les businesses qui contiennent ce mot-cl√© dans le nom
      // ET qui n'ont PAS d√©j√† de cat√©gories
      const { data, error } = await supabase
        .from('businesses')
        .update({ categories: [categoryId] })
        .ilike('name', `%${keyword}%`)
        .is('act_econ_code', null)
        .or('categories.is.null,categories.eq.{}')
        .select('id');

      if (error) {
        console.error(`‚ùå Erreur pour "${keyword}":`, error.message);
        continue;
      }

      const count = data?.length || 0;
      if (count > 0) {
        totalUpdated += count;
        console.log(`   ‚úÖ ${count.toLocaleString()} businesses mises √† jour`);
      }

      processedKeywords++;

      // Log progress tous les 10 mots-cl√©s
      if (processedKeywords % 10 === 0) {
        console.log(`\n‚è≥ Trait√© ${processedKeywords}/${Object.keys(CATEGORY_KEYWORDS).length} mots-cl√©s | ${totalUpdated.toLocaleString()} businesses mises √† jour\n`);
      }
    }

    console.log('\n‚úÖ TERMIN√â!');
    console.log(`üìä Mots-cl√©s trait√©s: ${processedKeywords}`);
    console.log(`üìä Businesses mises √† jour: ${totalUpdated.toLocaleString()}`);

    // V√©rification finale
    const { count: totalWithCategories } = await supabase
      .from('businesses')
      .select('id', { count: 'exact', head: true })
      .not('categories', 'is', null)
      .neq('categories', '[]');

    console.log(`\nüéØ Total businesses avec cat√©gories: ${totalWithCategories?.toLocaleString()}`);

  } catch (error) {
    console.error('‚ùå Erreur fatale:', error);
  }
}

assignCategoriesByName();
