# Configuration du Syst√®me de Quota d'Import Google

Ce guide explique comment configurer le syst√®me de quota pour limiter les imports Google Places √† 90 par jour (restant sous la limite gratuite de 100).

## üìã Vue d'ensemble

Le syst√®me de quota:
- ‚úÖ Limite les imports √† **90 par jour** (marge de s√©curit√© de 10)
- ‚úÖ Se r√©initialise automatiquement √† **minuit**
- ‚úÖ D√©sactive le bouton pour le public apr√®s 90 imports
- ‚úÖ Permet aux admins d'importer m√™me apr√®s 90 (avec avertissement de co√ªt)
- ‚úÖ Affiche un compteur en temps r√©el: "45/90 imports"
- ‚úÖ Page de monitoring dans le Dashboard admin

## üõ†Ô∏è √âtape 1: Cr√©er la table et les fonctions SQL

### Via Supabase Dashboard (Recommand√©)

1. **Acc√©dez √† Supabase Dashboard**
   - URL: https://supabase.com/dashboard
   - Projet: `xrmryfyhqrxzrhdbmwor`

2. **Ouvrez SQL Editor**
   - Cliquez sur "SQL Editor" dans le menu de gauche
   - Cliquez sur "New query"

3. **Ex√©cutez le script SQL**
   - Copiez tout le contenu du fichier: `supabase/migrations/create_google_import_stats.sql`
   - Collez-le dans l'√©diteur SQL
   - Cliquez sur "Run" (ou Ctrl+Enter)

4. **V√©rifiez la cr√©ation**
   - Allez dans "Table Editor"
   - Vous devriez voir la table `google_import_stats`
   - Elle devrait avoir une ligne avec la date d'aujourd'hui et count = 0

### V√©rification avec SQL

```sql
-- V√©rifier que la table existe
SELECT * FROM google_import_stats;

-- Tester la fonction get_import_quota_info
SELECT get_import_quota_info(90);

-- R√©sultat attendu:
-- {
--   "imports_today": 0,
--   "limit": 90,
--   "remaining": 90,
--   "can_import": true,
--   "percentage_used": 0,
--   "date": "2025-10-25"
-- }
```

## üîß √âtape 2: Configurer les variables d'environnement

### Variables Vercel (Production)

Dans Vercel Dashboard, ajoutez ces variables:

```bash
VITE_SUPABASE_URL=https://tiaofyawimkckjgxdnbd.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
GOOGLE_PLACES_API_KEY=AIzaSyAyZYhc6z1P7P6ZIyClIKfvIUhUhSoWH34
```

**Important**: Utilisez le `SUPABASE_SERVICE_KEY` (pas l'anon key) pour bypasser RLS.

### Variables Locales (.env)

Votre fichier `.env` local devrait d√©j√† avoir ces variables:

```bash
VITE_SUPABASE_URL=https://tiaofyawimkckjgxdnbd.supabase.co
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
GOOGLE_PLACES_API_KEY=AIzaSyAyZYhc6z1P7P6ZIyClIKfvIUhUhSoWH34
```

## üöÄ √âtape 3: Red√©marrer les serveurs

### En local

```bash
# Arr√™ter les serveurs actuels (Ctrl+C)

# Red√©marrer avec les nouvelles variables
npm run dev:all
```

### En production

1. **D√©ployez les changements sur Vercel**:
   ```bash
   git add .
   git commit -m "Add import quota system"
   git push
   ```

2. Vercel red√©ploiera automatiquement

## ‚úÖ √âtape 4: Tester le syst√®me

### Test 1: V√©rifier l'endpoint quota

```bash
# En local
curl http://localhost:3001/api/google-places/quota

# En production
curl https://registreduquebec.com/api/google-places/quota
```

**R√©sultat attendu**:
```json
{
  "imports_today": 0,
  "limit": 90,
  "remaining": 90,
  "can_import": true,
  "percentage_used": 0,
  "date": "2025-10-25"
}
```

### Test 2: Tester l'import modal

1. Allez sur une fiche d'entreprise
2. Cliquez sur "R√©clamer votre fiche"
3. Cliquez sur "Importer depuis Google"
4. Vous devriez voir: **"Imports aujourd'hui: 0/90"**
5. Le bouton "Rechercher" devrait avoir le badge "0/90"

### Test 3: Acc√©der au Dashboard Monitoring

1. Connectez-vous comme admin
2. Allez sur `/dashboard/import-monitoring`
3. Vous devriez voir:
   - Carte de statut avec emoji ‚úÖ
   - 4 cartes de statistiques
   - Barre de progression (devrait √™tre √† 0%)
   - Cartes d'information
   - Recommandations

## üìä Utilisation du Dashboard

### Acc√®s

URL: `/dashboard/import-monitoring`

Accessible uniquement aux administrateurs connect√©s.

### Fonctionnalit√©s

1. **Statut en temps r√©el**
   - Compteur d'imports aujourd'hui
   - Imports restants
   - Pourcentage d'utilisation

2. **Alertes**
   - ‚úÖ Vert: 0-79% (normal)
   - ‚ö†Ô∏è Orange: 80-99% (attention)
   - üö® Rouge: 100%+ (limite atteinte)

3. **Auto-refresh**
   - Actualisation automatique toutes les 30 secondes
   - Bouton manuel pour forcer la mise √† jour

4. **Informations**
   - Co√ªts apr√®s d√©passement
   - R√©initialisation quotidienne
   - Recommandations

## üîí S√©curit√© et Permissions

### Row Level Security (RLS)

Les politiques RLS sont configur√©es automatiquement:

- **Lecture publique**: Tout le monde peut lire le compteur (pour l'afficher sur le bouton)
- **√âcriture restreinte**: Seul le service role peut incr√©menter le compteur

### Backend uniquement

Le compteur est **toujours** incr√©ment√© c√¥t√© serveur (backend), jamais c√¥t√© client. Impossible de contourner la limite depuis le navigateur.

## üêõ D√©pannage

### Probl√®me: Erreur "Function get_import_quota_info does not exist"

**Solution**: Le script SQL n'a pas √©t√© ex√©cut√© correctement. R√©-ex√©cutez le script SQL complet.

### Probl√®me: Le compteur n'augmente pas

**Solution**:
1. V√©rifiez que `SUPABASE_SERVICE_KEY` est configur√© (pas l'anon key)
2. V√©rifiez les logs du backend avec `console.log`
3. Testez manuellement dans SQL Editor:
   ```sql
   SELECT increment_import_count();
   ```

### Probl√®me: Quota s'affiche comme "?/90"

**Solution**:
1. V√©rifiez que l'endpoint `/api/google-places/quota` r√©pond (test avec curl)
2. V√©rifiez la console du navigateur pour les erreurs
3. V√©rifiez que Supabase est accessible

### Probl√®me: Le compteur ne se r√©initialise pas √† minuit

**Solution**: Le compteur se r√©initialise automatiquement car chaque requ√™te v√©rifie `CURRENT_DATE`. Aucune action n√©cessaire. Si probl√®me persiste, v√©rifiez le fuseau horaire du serveur Supabase.

## üìà Monitoring des co√ªts

### Google Cloud Console

Pour voir vos co√ªts r√©els:

1. Allez sur: https://console.cloud.google.com/billing
2. S√©lectionnez votre projet
3. Regardez la section "Places API - Place Details"
4. V√©rifiez le nombre d'appels ce mois-ci

### Calcul estim√©

- 0-100 imports/jour = **$0 (GRATUIT)**
- 100-200 imports/jour = **~$2 CAD/jour**
- 200-500 imports/jour = **~$8 CAD/jour**
- 1000 imports/jour = **~$18 CAD/jour**

## üéØ Prochaines √©tapes (optionnel)

### Am√©liorations possibles

1. **Notifications email**
   - Envoyer un email √† l'admin √† 80 imports
   - Envoyer un email √† l'admin √† 90 imports

2. **Historique sur 30 jours**
   - Graphique des imports quotidiens
   - Tendances et moyennes
   - Export CSV

3. **Alertes Slack/Discord**
   - Webhook pour notifier l'√©quipe
   - Alertes en temps r√©el

4. **Limites par utilisateur**
   - Limiter les imports par utilisateur (ex: 5/jour)
   - Pr√©venir les abus

5. **Tests automatis√©s**
   - Tests unitaires pour le service quota
   - Tests d'int√©gration end-to-end

## üìù R√©sum√©

‚úÖ **Fichiers cr√©√©s**:
- `supabase/migrations/create_google_import_stats.sql`
- `api/google-places/quota.js`
- `src/services/importQuotaService.js`
- `src/pages/Dashboard/ImportMonitoring.jsx`
- `src/pages/Dashboard/ImportMonitoring.css`

‚úÖ **Fichiers modifi√©s**:
- `google-places-routes.js` (ajout route quota + v√©rification)
- `api/google-places/import.js` (ajout v√©rification quota)
- `src/components/GoogleImportModal.jsx` (affichage compteur)
- `src/components/GoogleImportModal.css` (styles quota)

‚úÖ **R√©sultat**:
- üéâ **100% gratuit** tant que < 90 imports/jour
- üîí **S√©curis√©** - impossible de contourner
- üìä **Monitoring** en temps r√©el dans le dashboard
- ‚ö†Ô∏è **Alertes** automatiques √† 80 et 90 imports
- üö´ **D√©sactivation** automatique du bouton public √† 90

---

**Support**: Si vous rencontrez des probl√®mes, v√©rifiez d'abord les logs du backend et la console du navigateur.
