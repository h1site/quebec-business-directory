# Guide d'Import des Entreprises du REQ

Ce guide explique comment importer en masse des milliers d'entreprises qu√©b√©coises depuis le **Registre des Entreprises du Qu√©bec (REQ)** et impl√©menter un syst√®me de r√©clamation pour que les propri√©taires puissent r√©clamer leur fiche.

## üìã Table des Mati√®res

1. [Vue d'ensemble](#vue-densemble)
2. [Pr√©requis](#pr√©requis)
3. [√âtape 1 : T√©l√©charger le dataset REQ](#√©tape-1--t√©l√©charger-le-dataset-req)
4. [√âtape 2 : Ex√©cuter les migrations](#√©tape-2--ex√©cuter-les-migrations)
5. [√âtape 3 : Importer les donn√©es](#√©tape-3--importer-les-donn√©es)
6. [√âtape 4 : Assigner les cat√©gories](#√©tape-4--assigner-les-cat√©gories)
7. [Syst√®me de r√©clamation](#syst√®me-de-r√©clamation)
8. [Statistiques et monitoring](#statistiques-et-monitoring)

---

## Vue d'ensemble

### Qu'est-ce que le REQ ?

Le **Registre des Entreprises du Qu√©bec** est la base de donn√©es officielle du gouvernement du Qu√©bec contenant toutes les entreprises incorpor√©es/enregistr√©es au Qu√©bec.

### Donn√©es disponibles (GRATUITES)

- ‚úÖ **NEQ** (Num√©ro d'Entreprise du Qu√©bec) - Identifiant unique
- ‚úÖ **Nom de l'entreprise**
- ‚úÖ **Adresse du domicile**
- ‚úÖ **Ville**
- ‚úÖ **Code postal**
- ‚úÖ **Code SCIAN** (2 activit√©s principales)
- ‚úÖ **Statut** (actif/inactif)
- ‚úÖ **Forme juridique**
- ‚ùå **T√©l√©phone** (non inclus)
- ‚ùå **Email** (non inclus)
- ‚ùå **Site web** (non inclus)

### Enrichissement automatique

Apr√®s import du REQ, notre syst√®me :

1. **Assigne automatiquement** la r√©gion et MRC bas√© sur la ville
2. **Cat√©gorise automatiquement** via mapping SCIAN ‚Üí Cat√©gories (85%+ pr√©cision)
3. **G√©n√®re slug SEO** unique pour chaque entreprise
4. **Permet r√©clamation** par les propri√©taires pour enrichir les donn√©es

---

## Pr√©requis

### 1. Logiciels requis

```bash
- Node.js v18+
- Supabase (compte + projet configur√©)
- Git
```

### 2. Variables d'environnement

Cr√©ez un fichier `.env` √† la racine :

```env
VITE_SUPABASE_URL=https://votre-projet.supabase.co
VITE_SUPABASE_ANON_KEY=votre-cle-anon
SUPABASE_SERVICE_KEY=votre-service-key  # Pour le script d'import
```

### 3. D√©pendances Node.js

```bash
npm install csv-parser @supabase/supabase-js
```

---

## √âtape 1 : T√©l√©charger le dataset REQ

### üì• Source officielle

1. Visitez : https://www.donneesquebec.ca/recherche/dataset/registre-des-entreprises
2. Cliquez sur "T√©l√©charger" pour le fichier CSV
3. Sauvegardez le fichier dans : `data/req-entreprises.csv`

```bash
# Cr√©er le dossier data s'il n'existe pas
mkdir -p data

# Placer le fichier t√©l√©charg√©
mv ~/Downloads/registre-entreprises.csv data/req-entreprises.csv
```

### üìä Taille du dataset

- **~150,000 entreprises actives** au Qu√©bec
- Fichier CSV : ~50-100 MB
- Temps de t√©l√©chargement : 2-5 minutes

---

## √âtape 2 : Ex√©cuter les migrations

### Migration principale

Cette migration ajoute :
- Colonnes pour tracking REQ (neq, scian_code, is_claimed, etc.)
- Table `scian_category_mapping` avec ~80 mappings SCIAN ‚Üí Cat√©gories
- Table `business_claims` pour g√©rer les r√©clamations

```bash
# Dans Supabase SQL Editor, ex√©cuter :
supabase/migration_add_req_import_support.sql
```

### V√©rification

```sql
-- V√©rifier que les tables existent
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
AND table_name IN ('scian_category_mapping', 'business_claims');

-- V√©rifier les mappings SCIAN
SELECT COUNT(*) as total_mappings FROM scian_category_mapping;
-- Devrait retourner ~80 mappings
```

---

## √âtape 3 : Importer les donn√©es

### Import complet (toutes les entreprises)

```bash
node scripts/import-req-businesses.js
```

### Import limit√© (test avec 1000 entreprises)

```bash
node scripts/import-req-businesses.js --limit=1000
```

### Mode dry-run (aper√ßu sans insertion)

```bash
node scripts/import-req-businesses.js --limit=10 --dry-run
```

### Sortie attendue

```
üöÄ Import des entreprises depuis le REQ
üìÇ Lecture du fichier CSV: data/req-entreprises.csv
‚úÖ Import√© 100/100 entreprises (100%)
‚úÖ Import√© 500/500 entreprises (100%)
...
‚úÖ Import termin√©!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä Statistiques:
   Total lu:        10000
   Total ins√©r√©:    9850
   Erreurs:         150
   Avec location:   9200 (92%)
   Avec SCIAN:      8500 (85%)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

### Temps d'ex√©cution estim√©

- **1,000 entreprises** : ~2-3 minutes
- **10,000 entreprises** : ~15-20 minutes
- **150,000 entreprises** : ~3-4 heures

---

## √âtape 4 : Assigner les cat√©gories

Une fois les entreprises import√©es, assignez automatiquement les cat√©gories bas√©es sur les codes SCIAN.

### Assignment automatique

```bash
node scripts/assign-categories-from-scian.js
```

### Options

```bash
# Limiter √† 1000 entreprises
node scripts/assign-categories-from-scian.js --limit=1000

# Mode dry-run pour voir les assignations
node scripts/assign-categories-from-scian.js --limit=100 --dry-run
```

### Sortie attendue

```
üè∑Ô∏è  Assignment automatique des cat√©gories bas√©es sur SCIAN
‚úÖ Trouv√© 8500 entreprises avec code SCIAN

üîç [DRY-RUN] Restaurant Chez Mario (Montr√©al)
   SCIAN: 722511 ‚Üí 7225 (Restaurants √† service complet)
   Confidence: 95%

‚úÖ Assignment termin√©!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìä Statistiques:
   Total trait√©:           8500
   Cat√©gories assign√©es:   7200 (85%)
   D√©j√† assign√©es:         0
   SCIAN non mapp√©:        1300 (15%)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
```

### Am√©liorer le taux de cat√©gorisation

Si le taux est inf√©rieur √† 80%, ajoutez plus de mappings SCIAN dans :
```
supabase/migration_add_req_import_support.sql
```

Consultez la liste compl√®te des codes SCIAN :
https://www23.statcan.gc.ca/imdb/p3VD_f.pl?Function=getVD&TVD=1181553

---

## Syst√®me de r√©clamation

### Concept

Les entreprises import√©es du REQ ont :
- `owner_id` = NULL (non r√©clam√©es)
- `is_claimed` = false
- `data_source` = 'req'

Les propri√©taires peuvent **r√©clamer leur fiche** pour :
- Prendre ownership
- Ajouter photos, horaires, description
- Enrichir les informations
- Obtenir badge "V√©rifi√© ‚úì"

### Workflow de r√©clamation

```mermaid
graph LR
    A[User voit fiche non r√©clam√©e] --> B[Clique "R√©clamer cette fiche"]
    B --> C[Remplit formulaire v√©rification]
    C --> D[Upload documents NEQ/facture]
    D --> E[Soumission claim]
    E --> F[Admin review]
    F --> G{Approuv√©?}
    G -->|Oui| H[Transfer ownership]
    G -->|Non| I[Rejet avec raison]
    H --> J[Email confirmation]
    J --> K[User peut √©diter fiche]
```

### Table business_claims

```sql
SELECT
  bc.id,
  b.name as business_name,
  b.neq,
  bc.claimant_name,
  bc.claimant_email,
  bc.status,
  bc.created_at
FROM business_claims bc
JOIN businesses b ON b.id = bc.business_id
WHERE bc.status = 'pending'
ORDER BY bc.created_at DESC;
```

---

## Statistiques et monitoring

### Entreprises par source

```sql
SELECT
  data_source,
  COUNT(*) as total,
  COUNT(CASE WHEN is_claimed THEN 1 END) as claimed,
  ROUND(COUNT(CASE WHEN is_claimed THEN 1 END)::numeric / COUNT(*) * 100, 2) as claim_rate
FROM businesses
GROUP BY data_source;
```

### Couverture g√©ographique

```sql
SELECT
  region,
  COUNT(*) as total_businesses,
  COUNT(DISTINCT city) as cities,
  COUNT(CASE WHEN is_claimed THEN 1 END) as claimed
FROM businesses
WHERE data_source = 'req'
GROUP BY region
ORDER BY total_businesses DESC;
```

### Cat√©gorisation automatique

```sql
SELECT
  COUNT(*) as total_req,
  COUNT(CASE WHEN auto_categorized THEN 1 END) as auto_categorized,
  ROUND(COUNT(CASE WHEN auto_categorized THEN 1 END)::numeric / COUNT(*) * 100, 2) as success_rate
FROM businesses
WHERE data_source = 'req';
```

### Top cat√©gories assign√©es

```sql
SELECT
  mc.label_fr as categorie,
  COUNT(DISTINCT b.id) as total_businesses
FROM businesses b
JOIN business_categories bc ON bc.business_id = b.id
JOIN sub_categories sc ON sc.id = bc.sub_category_id
JOIN main_categories mc ON mc.id = sc.main_category_id
WHERE b.data_source = 'req'
GROUP BY mc.label_fr
ORDER BY total_businesses DESC
LIMIT 10;
```

---

## FAQ

### Q: Le dataset REQ est-il vraiment gratuit ?

**R:** Oui, 100% gratuit. C'est une initiative de donn√©es ouvertes du gouvernement du Qu√©bec.

### Q: √Ä quelle fr√©quence le dataset est-il mis √† jour ?

**R:** Le dataset est mis √† jour mensuellement sur Donn√©es Qu√©bec.

### Q: Peut-on g√©ocoder les adresses gratuitement ?

**R:** Oui, utilisez Nominatim (OpenStreetMap) :
```bash
npm install node-geocoder
```

Mais c'est plus lent que Google Geocoding API.

### Q: Comment g√©rer les doublons avec Google Import ?

**R:** V√©rifiez d'abord si NEQ existe :

```javascript
const { data: existing } = await supabase
  .from('businesses')
  .select('id')
  .eq('neq', neq)
  .single();

if (existing) {
  // Fusionner ou ignorer
}
```

### Q: Les entreprises import√©es ont-elles des photos ?

**R:** Non. Les photos peuvent √™tre ajout√©es :
1. Manuellement apr√®s r√©clamation
2. Via Google Places API (si fiche r√©clam√©e)
3. Upload par propri√©taire

---

## Prochaines √©tapes

1. ‚úÖ Import REQ
2. ‚úÖ Assignment cat√©gories automatique
3. üîú Impl√©menter UI de r√©clamation (`ClaimBusinessModal.jsx`)
4. üîú Dashboard admin r√©clamations (`AdminClaims.jsx`)
5. üîú Syst√®me d'emails notifications
6. üîú Badge "V√©rifi√©" sur fiches r√©clam√©es

---

## Support

Pour questions ou probl√®mes :
- Email: Groupe.EOS@req.gouv.qc.ca (support dataset REQ)
- GitHub Issues: [Cr√©er une issue](https://github.com/votre-repo/issues)

---

## Licence

Le dataset REQ est sous licence ouverte du gouvernement du Qu√©bec.
Ce script d'import est sous licence MIT.
