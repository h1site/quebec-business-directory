-- ================================================
-- MIGRATION: Am√©lioration de la recherche
-- ================================================
-- Cette version fonctionne avec la structure r√©elle de la base de donn√©es
-- Ajoute la priorisation des fiches (claimed > manual > gmb)
-- ================================================

-- 1. Cr√©er l'index de priorisation
-- Les fiches r√©clam√©es (is_claimed=true) et manuelles (data_source='manual') sont prioritaires
CREATE INDEX IF NOT EXISTS idx_businesses_priority
ON businesses (
  is_claimed DESC NULLS LAST,
  (CASE WHEN data_source = 'manual' THEN 1 ELSE 0 END) DESC,
  created_at DESC
);

-- 2. Supprimer l'ancienne vue
DROP VIEW IF EXISTS businesses_enriched CASCADE;

-- 3. Recr√©er la vue avec le score de priorit√©
CREATE VIEW businesses_enriched AS
SELECT
  b.*,
  mc.slug as primary_main_category_slug,
  mc.label_fr as primary_main_category_fr,
  mc.label_en as primary_main_category_en,
  sc.slug as primary_sub_category_slug,
  sc.label_fr as primary_sub_category_fr,
  sc.label_en as primary_sub_category_en,
  -- Score de priorit√© pour le tri des r√©sultats
  -- 3 = Fiche r√©clam√©e (priorit√© maximale)
  -- 2 = Fiche cr√©√©e manuellement
  -- 1 = Fiche import√©e de GMB
  CASE
    WHEN b.is_claimed = true THEN 3
    WHEN b.data_source = 'manual' THEN 2
    ELSE 1
  END as search_priority_score,
  -- Versions lowercase pour recherche insensible √† la casse
  lower(b.name) as name_lower,
  lower(b.address) as address_lower
FROM businesses b
LEFT JOIN business_categories bc ON b.id = bc.business_id AND bc.is_primary = true
LEFT JOIN sub_categories sc ON bc.sub_category_id = sc.id
LEFT JOIN main_categories mc ON sc.main_category_id = mc.id;

-- 4. Cr√©er un index sur le nom en minuscules
CREATE INDEX IF NOT EXISTS idx_businesses_name_lower
ON businesses (lower(name));

-- 5. Commenter la vue
COMMENT ON VIEW businesses_enriched IS 'Vue enrichie des entreprises avec cat√©gories et score de priorit√©. Score: 3=r√©clam√©e, 2=manuelle, 1=GMB';

-- 6. Afficher les r√©sultats
DO $$
DECLARE
  claimed_count int;
  manual_count int;
  gmb_count int;
  total_count int;
BEGIN
  SELECT COUNT(*) INTO claimed_count FROM businesses WHERE is_claimed = true;
  SELECT COUNT(*) INTO manual_count FROM businesses WHERE data_source = 'manual';
  SELECT COUNT(*) INTO gmb_count FROM businesses WHERE data_source = 'gmb';
  SELECT COUNT(*) INTO total_count FROM businesses;

  RAISE NOTICE '';
  RAISE NOTICE '‚úÖ Migration termin√©e avec succ√®s!';
  RAISE NOTICE '';
  RAISE NOTICE 'üìä Statistiques:';
  RAISE NOTICE '   Total: % entreprises', total_count;
  RAISE NOTICE '   Fiches r√©clam√©es: % (priorit√© 3)', claimed_count;
  RAISE NOTICE '   Fiches manuelles: % (priorit√© 2)', manual_count;
  RAISE NOTICE '   Fiches GMB: % (priorit√© 1)', gmb_count;
  RAISE NOTICE '';
  RAISE NOTICE 'üîç Ordre de tri dans les r√©sultats de recherche:';
  RAISE NOTICE '   1Ô∏è‚É£  Fiches r√©clam√©es (is_claimed = true)';
  RAISE NOTICE '   2Ô∏è‚É£  Fiches cr√©√©es manuellement (data_source = manual)';
  RAISE NOTICE '   3Ô∏è‚É£  Fiches import√©es GMB (data_source = gmb)';
  RAISE NOTICE '';
  RAISE NOTICE 'üí° Note: Recherche insensible √† la casse activ√©e';
  RAISE NOTICE '   "MONTREAL" trouve "Montr√©al", "Montreal", "montreal"';
  RAISE NOTICE '';
END $$;
