# Automatisation de la R√©g√©n√©ration des Sitemaps

Ce document explique comment automatiser la r√©g√©n√©ration des sitemaps pour un site avec contenu dynamique.

## üìã Solutions Disponibles

### 1. API Endpoint (On-Demand) ‚ö° RECOMMAND√â

**Fichier**: `api/regenerate-sitemaps.js`

**Utilisation**:
```javascript
// Dans n'importe quel composant apr√®s ajout d'entreprise
import { triggerSitemapRegenerationDelayed } from '../utils/sitemapTrigger';

const handleSubmit = async (formData) => {
  // 1. Sauvegarder l'entreprise
  await saveBusinessToDatabase(formData);

  // 2. D√©clencher la r√©g√©n√©ration (avec d√©lai de 1 minute)
  triggerSitemapRegenerationDelayed('business_added', 60000);
};
```

**Avantages**:
- ‚úÖ R√©g√©n√©ration imm√©diate apr√®s ajout de contenu
- ‚úÖ Contr√¥le total sur quand r√©g√©n√©rer
- ‚úÖ Peut √™tre appel√© depuis l'interface admin
- ‚úÖ S√©curis√© avec cl√© secr√®te

**Configuration**:
```env
# .env
VITE_SITEMAP_REGENERATE_URL=/api/regenerate-sitemaps
VITE_SITEMAP_REGENERATE_SECRET=votre-cle-secrete-super-longue-123
SITEMAP_REGENERATE_SECRET=votre-cle-secrete-super-longue-123
```

---

### 2. GitHub Actions (Automatique Quotidien) ü§ñ

**Fichier**: `.github/workflows/regenerate-sitemaps.yml`

**Fonctionnalit√©s**:
- ‚è∞ R√©g√©n√©ration automatique chaque nuit √† 3h (23h EST)
- üîò D√©clenchement manuel via GitHub UI
- üì§ Commit et push automatique des nouveaux sitemaps
- üîî Notification √† Google apr√®s r√©g√©n√©ration

**Comment d√©clencher manuellement**:
1. Aller sur GitHub ‚Üí Actions
2. S√©lectionner "R√©g√©n√©ration Automatique des Sitemaps"
3. Cliquer sur "Run workflow"

**Avantages**:
- ‚úÖ Z√©ro maintenance
- ‚úÖ R√©g√©n√©ration garantie chaque jour
- ‚úÖ Gratuit avec GitHub
- ‚úÖ Logs disponibles dans GitHub Actions

---

### 3. Supabase Database Trigger (Temps R√©el) ‚ö°‚ö°

**Pour les plus avanc√©s**: Cr√©er un trigger Supabase qui appelle l'API apr√®s INSERT/UPDATE

```sql
-- Cr√©er une fonction PostgreSQL
CREATE OR REPLACE FUNCTION notify_sitemap_regeneration()
RETURNS TRIGGER AS $$
BEGIN
  -- Appeler l'API de r√©g√©n√©ration
  PERFORM net.http_post(
    url := 'https://registreduquebec.com/api/regenerate-sitemaps',
    body := jsonb_build_object(
      'secret', 'votre-cle-secrete',
      'reason', 'database_trigger'
    )
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Cr√©er le trigger sur la table businesses
CREATE TRIGGER sitemap_regeneration_trigger
AFTER INSERT OR UPDATE OR DELETE ON businesses
FOR EACH STATEMENT
EXECUTE FUNCTION notify_sitemap_regeneration();
```

**Avantages**:
- ‚úÖ Temps r√©el absolu
- ‚úÖ Aucun code front-end n√©cessaire
- ‚ö†Ô∏è Peut r√©g√©n√©rer tr√®s souvent (utiliser un throttle)

---

## üéØ Recommandation par Sc√©nario

### Sc√©nario 1: Site avec peu d'ajouts (< 10/jour)
**Solution**: GitHub Actions (quotidien)
- Simple et suffisant
- Z√©ro code √† maintenir

### Sc√©nario 2: Site avec ajouts mod√©r√©s (10-100/jour)
**Solution**: API Endpoint avec d√©lai
- R√©g√©n√©ration group√©e toutes les heures
- Appel depuis l'interface admin

### Sc√©nario 3: Site avec nombreux ajouts (> 100/jour)
**Solution**: GitHub Actions (quotidien) + API Endpoint manuel
- R√©g√©n√©ration quotidienne automatique
- Option manuelle si urgent

### Sc√©nario 4: Site critique (besoin temps r√©el)
**Solution**: Supabase Trigger + Throttling
- Mise √† jour imm√©diate
- Throttle pour √©viter surcharge

---

## üìù Exemple d'Int√©gration dans un Formulaire

```jsx
import { useState } from 'react';
import { triggerSitemapRegenerationDelayed } from '../utils/sitemapTrigger';
import { supabase } from '../lib/supabase';

export default function AddBusinessForm() {
  const [formData, setFormData] = useState({});
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    try {
      // 1. Sauvegarder l'entreprise
      const { data, error } = await supabase
        .from('businesses')
        .insert([formData]);

      if (error) throw error;

      // 2. D√©clencher r√©g√©n√©ration sitemap (dans 5 minutes)
      triggerSitemapRegenerationDelayed('business_added', 300000);

      alert('‚úÖ Entreprise ajout√©e! Le sitemap sera mis √† jour dans 5 minutes.');

    } catch (error) {
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* Vos champs de formulaire */}
      <button type="submit" disabled={loading}>
        {loading ? 'Ajout en cours...' : 'Ajouter l\'entreprise'}
      </button>
    </form>
  );
}
```

---

## üîß Configuration Vercel (si h√©berg√© sur Vercel)

Vercel r√©g√©n√®re automatiquement le site √† chaque push. Avec GitHub Actions, les sitemaps seront push√©s automatiquement, d√©clenchant un nouveau build.

**Optimisation**: D√©sactiver le rebuild pour les commits de sitemap:

```javascript
// vercel.json
{
  "git": {
    "deploymentEnabled": {
      "main": true
    }
  },
  "github": {
    "enabled": true,
    "autoJobCancelation": true,
    "silent": true
  },
  "build": {
    "env": {
      "SKIP_REBUILD": "true"
    }
  }
}
```

Ou ignorer les commits avec `[skip ci]` (d√©j√† configur√© dans le workflow).

---

## üöÄ D√©marrage Rapide

### √âtape 1: Configurer les secrets
```bash
# Ajouter √† .env
echo "SITEMAP_REGENERATE_SECRET=$(openssl rand -hex 32)" >> .env
```

### √âtape 2: Configurer GitHub Secrets
1. GitHub ‚Üí Settings ‚Üí Secrets ‚Üí New repository secret
2. Ajouter `VITE_SUPABASE_URL` et `VITE_SUPABASE_ANON_KEY`

### √âtape 3: Tester l'API
```bash
curl -X POST http://localhost:3000/api/regenerate-sitemaps \
  -H "Content-Type: application/json" \
  -d '{"secret":"votre-cle-secrete"}'
```

### √âtape 4: Activer GitHub Actions
- Le workflow s'ex√©cutera automatiquement chaque nuit
- Ou d√©clenchement manuel via GitHub UI

---

## üìä Monitoring

### V√©rifier la derni√®re r√©g√©n√©ration
```bash
# Date du dernier sitemap g√©n√©r√©
ls -lh public/sitemap.xml

# Nombre d'URLs dans le sitemap
grep -c "<loc>" public/sitemap.xml
```

### Notifier Google apr√®s r√©g√©n√©ration
```bash
# Automatique dans GitHub Actions, ou manuel:
curl "https://www.google.com/ping?sitemap=https://registreduquebec.com/sitemap.xml"
```

---

## ‚ùì FAQ

**Q: Combien de temps prend la r√©g√©n√©ration?**
R: ~3-5 minutes pour 480k entreprises

**Q: Puis-je r√©g√©n√©rer trop souvent?**
R: Oui. Google recommande max 1x par jour pour les gros sites. Utilisez le d√©lai.

**Q: Le site sera-t-il down pendant la r√©g√©n√©ration?**
R: Non, les anciens sitemaps restent disponibles pendant la g√©n√©ration.

**Q: Que se passe-t-il si la r√©g√©n√©ration √©choue?**
R: Les anciens sitemaps restent en place. V√©rifiez les logs GitHub Actions.

---

## üîó Liens Utiles

- [Documentation Google Sitemaps](https://developers.google.com/search/docs/crawling-indexing/sitemaps/build-sitemap)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Vercel Deployment Hooks](https://vercel.com/docs/concepts/git/deploy-hooks)
