# Configuration des Notifications Email

## üìß Vue d'ensemble

Le syst√®me envoie automatiquement des emails pour:
1. **Nouvelle r√©clamation** ‚Üí Email √† info@h1site.com
2. **R√©clamation approuv√©e** ‚Üí Email au demandeur
3. **R√©clamation rejet√©e** ‚Üí Email au demandeur avec raison

## üîß Configuration (100% GRATUIT)

### √âtape 1: Cr√©er un compte Resend

1. Aller sur [resend.com](https://resend.com)
2. S'inscrire (gratuit jusqu'√† 3000 emails/mois)
3. V√©rifier votre email

### √âtape 2: Obtenir la cl√© API Resend

1. Dans le dashboard Resend, aller dans **API Keys**
2. Cliquer sur **Create API Key**
3. Nommer: `Quebec Business Directory`
4. Copier la cl√© (commence par `re_...`)

### √âtape 3: Configurer le domaine d'envoi

**Option A: Utiliser votre domaine (recommand√©)**
1. Dans Resend, aller dans **Domains**
2. Cliquer **Add Domain**
3. Entrer: `registreduquebec.com`
4. Ajouter les enregistrements DNS (DKIM, SPF, etc.)
5. Attendre la v√©rification (~10 minutes)

**Option B: Utiliser le domaine sandbox (test seulement)**
- Emails envoy√©s uniquement aux adresses v√©rifi√©es
- Bon pour tester, pas pour production

### √âtape 4: Installer Supabase CLI

```bash
# macOS
brew install supabase/tap/supabase

# Windows (PowerShell)
scoop bucket add supabase https://github.com/supabase/scoop-bucket.git
scoop install supabase

# Linux
brew install supabase/tap/supabase
```

### √âtape 5: D√©ployer la fonction Edge

```bash
# Se connecter √† Supabase
supabase login

# Lier le projet
supabase link --project-ref YOUR_PROJECT_REF
# Trouver YOUR_PROJECT_REF dans: Supabase Dashboard ‚Üí Settings ‚Üí General

# D√©ployer la fonction
supabase functions deploy send-claim-notification
```

### √âtape 6: Configurer les secrets

```bash
# Ajouter la cl√© API Resend
supabase secrets set RESEND_API_KEY=re_votre_cle_ici

# V√©rifier
supabase secrets list
```

### √âtape 7: Tester la fonction

```bash
# Test local
supabase functions serve send-claim-notification

# Dans un autre terminal
curl -i --location --request POST 'http://localhost:54321/functions/v1/send-claim-notification' \
  --header 'Authorization: Bearer YOUR_ANON_KEY' \
  --header 'Content-Type: application/json' \
  --data '{
    "type": "new_claim",
    "claim": {
      "user_email": "test@example.com",
      "user_name": "Test User",
      "verification_method": "manual",
      "status": "pending"
    },
    "business": {
      "name": "Test Business",
      "city": "Montreal",
      "slug": "test-business"
    }
  }'
```

## üìù Types d'emails envoy√©s

### 1. Nouvelle r√©clamation (`new_claim`)

**Destinataire:** info@h1site.com

**Contenu:**
```
Sujet: üîî Nouvelle r√©clamation: [Nom entreprise]

Nouvelle r√©clamation de fiche d'entreprise

Entreprise:
- Nom: [Nom]
- Ville: [Ville]
- URL: [Lien vers la fiche]

Demandeur:
- Email: [Email]
- Nom: [Nom]
- T√©l√©phone: [T√©l]

M√©thode: [Email domaine / Google Business / Manuel]

Status:
‚úÖ Approuv√© automatiquement (si domaine correspond)
OU
‚è≥ En attente de r√©vision

[Bouton: G√©rer les r√©clamations]
```

### 2. R√©clamation approuv√©e (`claim_approved`)

**Destinataire:** Email du demandeur

**Contenu:**
```
Sujet: ‚úÖ R√©clamation approuv√©e: [Nom entreprise]

Votre r√©clamation a √©t√© approuv√©e!

F√©licitations! Votre demande pour [Nom entreprise] a √©t√© approuv√©e.

Prochaines √©tapes:
- G√©rer cette fiche
- Modifier les informations
- Ajouter des photos
- R√©pondre aux avis

[Bouton: G√©rer ma fiche]
```

### 3. R√©clamation rejet√©e (`claim_rejected`)

**Destinataire:** Email du demandeur

**Contenu:**
```
Sujet: ‚ùå R√©clamation non approuv√©e: [Nom entreprise]

Votre r√©clamation n'a pas √©t√© approuv√©e

Malheureusement, votre demande pour [Nom entreprise] n'a pas pu √™tre approuv√©e.

Raison:
[Raison fournie par l'admin]

Que faire ensuite?
- V√©rifier que vous √™tes bien le propri√©taire
- Pr√©parer des documents justificatifs
- Nous contacter pour plus d'informations

[Bouton: Nous contacter]
```

## üîç V√©rification du d√©ploiement

### Dans Supabase Dashboard:

1. Aller dans **Edge Functions**
2. V√©rifier que `send-claim-notification` appara√Æt
3. Cliquer dessus pour voir les logs

### Tester depuis l'application:

1. Se connecter avec un compte test
2. R√©clamer une fiche d'entreprise
3. V√©rifier l'email re√ßu √† info@h1site.com

## üêõ D√©pannage

### Erreur: "Function not found"
```bash
# Re-d√©ployer la fonction
supabase functions deploy send-claim-notification --no-verify-jwt
```

### Erreur: "RESEND_API_KEY not set"
```bash
# V√©rifier les secrets
supabase secrets list

# Re-d√©finir
supabase secrets set RESEND_API_KEY=re_votre_cle_ici
```

### Emails non re√ßus

1. **V√©rifier les logs Supabase:**
   - Dashboard ‚Üí Edge Functions ‚Üí send-claim-notification ‚Üí Logs

2. **V√©rifier les logs Resend:**
   - Dashboard Resend ‚Üí Emails
   - Chercher l'email par destinataire

3. **V√©rifier le spam:**
   - Emails peuvent arriver dans spam initialement
   - Marquer comme "Pas spam" pour les futurs emails

### Domaine non v√©rifi√©

1. **V√©rifier les enregistrements DNS:**
   ```bash
   dig TXT registreduquebec.com
   ```

2. **Attendre la propagation DNS:**
   - Peut prendre jusqu'√† 24h
   - Utiliser [dnschecker.org](https://dnschecker.org)

3. **En attendant:**
   - Utiliser le domaine sandbox Resend
   - Ajouter info@h1site.com comme adresse v√©rifi√©e

## üí∞ Limites gratuites

### Resend (gratuit)
- ‚úÖ 3000 emails/mois
- ‚úÖ 100 emails/jour
- ‚úÖ Domaines personnalis√©s illimit√©s
- ‚úÖ API compl√®te
- ‚úÖ Webhooks
- ‚ùå Support prioritaire (payant)

### Supabase Edge Functions (gratuit)
- ‚úÖ 500k invocations/mois
- ‚úÖ 400k GB-s compute/mois
- ‚úÖ 100 fonctions
- ‚ùå Support prioritaire (payant)

**Conclusion:** Largement suffisant pour des milliers de r√©clamations/mois, 100% gratuit!

## üöÄ Aller plus loin

### Ajouter plus de templates

Modifier `supabase/functions/send-claim-notification/index.ts`:

```typescript
case 'reminder':
  emailSubject = '‚è∞ Rappel: R√©clamation en attente'
  emailHtml = `...`
  break
```

### Utiliser des templates Resend

```typescript
const res = await fetch('https://api.resend.com/emails', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${RESEND_API_KEY}`,
  },
  body: JSON.stringify({
    from: 'Registre du Qu√©bec <noreply@registreduquebec.com>',
    to: [toEmail],
    subject: emailSubject,
    react: EmailTemplate({ claim, business }) // Utiliser React Email
  }),
})
```

### Ajouter des pi√®ces jointes

```typescript
body: JSON.stringify({
  from: '...',
  to: [...],
  subject: '...',
  html: '...',
  attachments: [
    {
      filename: 'verification.pdf',
      content: base64Content
    }
  ]
})
```

## üìä Monitoring

### Dashboard Resend
- Emails envoy√©s/jour
- Taux de d√©livrabilit√©
- Bounces & Plaintes
- Temps de r√©ponse API

### Dashboard Supabase
- Invocations de fonction
- Temps d'ex√©cution
- Erreurs
- Logs en temps r√©el

### Alertes recommand√©es

1. **Email rate limit atteint** ‚Üí Passer au plan payant
2. **Taux d'erreur > 5%** ‚Üí V√©rifier les logs
3. **Domaine non v√©rifi√©** ‚Üí V√©rifier DNS

bash scripts/enrich-google-loop.sh 2>&1 | tee logs/enrich-google-midnight.log &
